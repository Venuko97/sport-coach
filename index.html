import React, { useEffect, useMemo, useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Switch } from "@/components/ui/switch";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Textarea } from "@/components/ui/textarea";
import { Checkbox } from "@/components/ui/checkbox";
import {
  LineChart,
  Line,
  CartesianGrid,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  BarChart,
  Bar,
  Legend,
} from "recharts";

// -----------------------------
// Small, practical, "good-enough" logic (not medical advice)
// -----------------------------

const STORAGE_KEY = "vibe_sport_coach_v5";
const NL = String.fromCharCode(10);
const NL2 = NL + NL;

const clamp = (n: number, a: number, b: number) => Math.max(a, Math.min(b, n));
const round = (n: number, d = 0) => {
  const p = 10 ** d;
  return Math.round((Number(n) + Number.EPSILON) * p) / p;
};

function toISODateLocal(d: Date) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const da = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${da}`;
}

function parseISODateLocal(iso: string) {
  const [y, m, d] = String(iso).split("-").map((x) => Number(x));
  return new Date(y || 1970, (m || 1) - 1, d || 1);
}

function addDaysISO(iso: string, days: number) {
  const d = parseISODateLocal(iso);
  d.setDate(d.getDate() + days);
  return toISODateLocal(d);
}

function weekStartMondayISO(now = new Date()) {
  const d = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const weekdayMon0 = (d.getDay() + 6) % 7; // Mon=0 ... Sun=6
  d.setDate(d.getDate() - weekdayMon0);
  return toISODateLocal(d);
}

function calcBMR({ sex, weightKg, heightCm, age }: { sex: string; weightKg: number; heightCm: number; age: number }) {
  // Mifflin-St Jeor
  const w = Number(weightKg) || 0;
  const h = Number(heightCm) || 0;
  const a = Number(age) || 0;
  if (!w || !h || !a) return 0;
  if (sex === "female") return 10 * w + 6.25 * h - 5 * a - 161;
  return 10 * w + 6.25 * h - 5 * a + 5;
}

function activityFactor(level: string) {
  switch (level) {
    case "sedentary":
      return 1.2;
    case "light":
      return 1.375;
    case "moderate":
      return 1.55;
    case "high":
      return 1.725;
    case "athlete":
      return 1.9;
    default:
      return 1.55;
  }
}

function paceToKgPerWeek(pace: string) {
  if (pace === "conservative") return 0.35;
  if (pace === "aggressive") return 0.9;
  return 0.6;
}

function estimateWeeklyForecast({ currentWeightKg, loseKg, pace }: { currentWeightKg: number; loseKg: number; pace: string }) {
  const start = Number(currentWeightKg) || 0;
  const targetLoss = clamp(Number(loseKg) || 0, 0, 80);
  const rate = paceToKgPerWeek(pace);
  if (!start || !targetLoss) return [] as Array<{ week: string; weight: number }>;

  const weeks = clamp(Math.ceil(targetLoss / rate), 1, 52);
  const data: Array<{ week: string; weight: number }> = [];
  for (let i = 0; i <= weeks; i++) {
    const progressLoss = clamp(i * rate, 0, targetLoss);
    const projected = round(start - progressLoss, 1);
    data.push({ week: `–ù–µ–¥ ${i}`, weight: projected });
  }
  return data;
}

// -----------------------------
// Macro targets (auto)
// -----------------------------

function macroTargets({ weightKg, caloriesTarget, focus }: { weightKg: number; caloriesTarget: number; focus: string }) {
  const w = Number(weightKg) || 0;
  const cal = Number(caloriesTarget) || 0;
  if (!w || !cal) return { p: 0, f: 0, c: 0 };

  const p = clamp(Math.round(w * (focus === "fat_loss" ? 1.9 : 1.7)), 80, 240);
  const f = clamp(Math.round(w * 0.8), 40, 120);
  const kcalPF = p * 4 + f * 9;
  const c = Math.max(0, Math.round((cal - kcalPF) / 4));
  return { p, f, c };
}

// -----------------------------
// Food templates (per 1 serving) + FOOD DB (per 100g)
// -----------------------------

const UNIT_KIND: Record<string, "piece" | "liquid" | "mass"> = {
  "—à—Ç": "piece",
  "–±–∞–Ω": "piece",
  "–±–∞—Ç–æ–Ω": "piece",
  "–ø–∞—á": "piece",
  "–≥–æ–ª": "piece",
  "–ª": "liquid",
  "–º–ª": "liquid",
  "–≥": "mass",
};

function formatShoppingQty(qty: number, unit: string) {
  const kind = UNIT_KIND[unit] || "mass";
  if (kind === "piece") return `${Math.ceil(qty)} ${unit}`;
  if (unit === "–º–ª") return `${Math.round(qty / 10) * 10} –º–ª`;
  if (unit === "–ª") return `${round(qty, 1)} –ª`;
  return `${Math.round(qty)} ${unit}`;
}

type Ingredient = { name: string; qty: number; unit: string };

type Meal = {
  name: string;
  kcal: number;
  p: number;
  f: number;
  c: number;
  ingredients: Ingredient[];
};

type FoodItem = {
  id: string;
  name: string;
  kcal100: number;
  p100: number;
  f100: number;
  c100: number;
  tags?: string[];
};

// –û—á–µ–Ω—å –≥—Ä—É–±—ã–µ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è (–ø–æ–¥–æ–π–¥—É—Ç –¥–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞)
const FOOD_DB: FoodItem[] = [
  { id: "chicken_breast", name: "–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ (–≥–æ—Ç–æ–≤–∞—è)", kcal100: 165, p100: 31, f100: 3.6, c100: 0, tags: ["protein"] },
  { id: "turkey", name: "–ò–Ω–¥–µ–π–∫–∞ (–≥–æ—Ç–æ–≤–∞—è)", kcal100: 150, p100: 29, f100: 2.5, c100: 0, tags: ["protein"] },
  { id: "tuna", name: "–¢—É–Ω–µ—Ü (–∫–æ–Ω—Å–µ—Ä–≤–∞, –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º)", kcal100: 120, p100: 26, f100: 1, c100: 0, tags: ["protein"] },
  { id: "salmon", name: "–õ–æ—Å–æ—Å—å (–≥–æ—Ç–æ–≤—ã–π)", kcal100: 210, p100: 22, f100: 13, c100: 0, tags: ["protein", "fat"] },
  { id: "eggs", name: "–Ø–π—Ü–∞ (—Ü–µ–ª—å–Ω—ã–µ)", kcal100: 143, p100: 13, f100: 10, c100: 1, tags: ["protein", "fat"] },
  { id: "cottage", name: "–¢–≤–æ—Ä–æ–≥ 5%", kcal100: 121, p100: 17, f100: 5, c100: 3, tags: ["protein"] },
  { id: "yogurt", name: "–ô–æ–≥—É—Ä—Ç –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π", kcal100: 60, p100: 4, f100: 3, c100: 5, tags: ["protein"] },
  { id: "kefir", name: "–ö–µ—Ñ–∏—Ä 1%", kcal100: 40, p100: 3, f100: 1, c100: 4, tags: ["protein"] },

  { id: "oats", name: "–û–≤—Å—è–Ω—ã–µ —Ö–ª–æ–ø—å—è", kcal100: 370, p100: 13, f100: 7, c100: 62, tags: ["carb"] },
  { id: "rice", name: "–†–∏—Å (—Å—ã—Ä–æ–π)", kcal100: 360, p100: 7, f100: 1, c100: 79, tags: ["carb"] },
  { id: "buckwheat", name: "–ì—Ä–µ—á–∫–∞ (—Å—ã—Ä–∞—è)", kcal100: 343, p100: 13, f100: 3, c100: 71, tags: ["carb"] },
  { id: "pasta", name: "–ü–∞—Å—Ç–∞ (—Å—ã—Ä–∞—è)", kcal100: 350, p100: 12, f100: 2, c100: 72, tags: ["carb"] },
  { id: "potato", name: "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", kcal100: 77, p100: 2, f100: 0.1, c100: 17, tags: ["carb"] },
  { id: "bread", name: "–•–ª–µ–± —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π", kcal100: 250, p100: 9, f100: 4, c100: 43, tags: ["carb"] },

  { id: "olive_oil", name: "–û–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ", kcal100: 884, p100: 0, f100: 100, c100: 0, tags: ["fat"] },
  { id: "nuts", name: "–û—Ä–µ—Ö–∏ (–º–∏–∫—Å)", kcal100: 600, p100: 15, f100: 55, c100: 10, tags: ["fat"] },

  { id: "banana", name: "–ë–∞–Ω–∞–Ω", kcal100: 89, p100: 1.1, f100: 0.3, c100: 23, tags: ["carb", "fruit"] },
  { id: "apple", name: "–Ø–±–ª–æ–∫–æ", kcal100: 52, p100: 0.3, f100: 0.2, c100: 14, tags: ["carb", "fruit"] },
  { id: "berries", name: "–Ø–≥–æ–¥—ã (–∑–∞–º–æ—Ä.)", kcal100: 50, p100: 1, f100: 0.5, c100: 10, tags: ["carb", "fruit"] },

  { id: "veg_mix", name: "–û–≤–æ—â–∏ (–∑–∞–º–æ—Ä. —Å–º–µ—Å—å)", kcal100: 50, p100: 2, f100: 0.5, c100: 9, tags: ["veg"] },
  { id: "tomato", name: "–ü–æ–º–∏–¥–æ—Ä—ã", kcal100: 18, p100: 0.9, f100: 0.2, c100: 3.9, tags: ["veg"] },
  { id: "cucumber", name: "–û–≥—É—Ä—Ü—ã", kcal100: 15, p100: 0.7, f100: 0.1, c100: 3.6, tags: ["veg"] },
  { id: "broccoli", name: "–ë—Ä–æ–∫–∫–æ–ª–∏", kcal100: 34, p100: 2.8, f100: 0.4, c100: 7, tags: ["veg"] },
];

type MealFoodEntry = { foodId: string; grams: number };

function foodById(id: string) {
  return FOOD_DB.find((f) => f.id === id) || null;
}

function macrosFromFood(food: FoodItem, grams: number) {
  const g = Number(grams) || 0;
  const k = g / 100;
  return {
    kcal: round(food.kcal100 * k, 0),
    p: round(food.p100 * k, 1),
    f: round(food.f100 * k, 1),
    c: round(food.c100 * k, 1),
  };
}

function computeMealFromFoods(entries: MealFoodEntry[]) {
  const sum = { kcal: 0, p: 0, f: 0, c: 0 };
  const parts: string[] = [];
  for (const e of entries || []) {
    const food = foodById(e.foodId);
    const grams = Number(e.grams) || 0;
    if (!food || grams <= 0) continue;
    const m = macrosFromFood(food, grams);
    sum.kcal += Number(m.kcal) || 0;
    sum.p += Number(m.p) || 0;
    sum.f += Number(m.f) || 0;
    sum.c += Number(m.c) || 0;
    parts.push(`${food.name} ${Math.round(grams)}–≥`);
  }
  return {
    name: parts.length ? parts.join(", ") : "",
    kcal: Math.round(sum.kcal),
    p: round(sum.p, 1),
    f: round(sum.f, 1),
    c: round(sum.c, 1),
  };
}

const FOOD_LIBRARY: Record<string, Meal[]> = {
  breakfast: [
    {
      name: "–û–≤—Å—è–Ω–∫–∞ + —è–≥–æ–¥—ã + –π–æ–≥—É—Ä—Ç",
      kcal: 430,
      p: 24,
      f: 10,
      c: 60,
      ingredients: [
        { name: "–æ–≤—Å—è–Ω—ã–µ —Ö–ª–æ–ø—å—è", qty: 60, unit: "–≥" },
        { name: "–π–æ–≥—É—Ä—Ç –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π", qty: 200, unit: "–≥" },
        { name: "—è–≥–æ–¥—ã (–∑–∞–º–æ—Ä.)", qty: 120, unit: "–≥" },
        { name: "–º—ë–¥", qty: 10, unit: "–≥" },
      ],
    },
    {
      name: "–Ø–π—Ü–∞ + —Ç–æ—Å—Ç + –æ–≤–æ—â–∏",
      kcal: 460,
      p: 26,
      f: 18,
      c: 45,
      ingredients: [
        { name: "—è–π—Ü–∞", qty: 2, unit: "—à—Ç" },
        { name: "—Ö–ª–µ–± —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π", qty: 2, unit: "—à—Ç" },
        { name: "–ø–æ–º–∏–¥–æ—Ä—ã", qty: 150, unit: "–≥" },
        { name: "–æ–≥—É—Ä—Ü—ã", qty: 150, unit: "–≥" },
        { name: "–æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ", qty: 5, unit: "–º–ª" },
      ],
    },
  ],
  lunch: [
    {
      name: "–ö—É—Ä–∏—Ü–∞ + —Ä–∏—Å + —Å–∞–ª–∞—Ç",
      kcal: 650,
      p: 45,
      f: 14,
      c: 82,
      ingredients: [
        { name: "–∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞", qty: 170, unit: "–≥" },
        { name: "—Ä–∏—Å", qty: 80, unit: "–≥" },
        { name: "—Å–∞–ª–∞—Ç–Ω—ã–µ –ª–∏—Å—Ç—å—è", qty: 60, unit: "–≥" },
        { name: "–ø–æ–º–∏–¥–æ—Ä—ã", qty: 150, unit: "–≥" },
        { name: "–æ–≥—É—Ä—Ü—ã", qty: 150, unit: "–≥" },
      ],
    },
    {
      name: "–¢—É–Ω–µ—Ü + –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å + –æ–≤–æ—â–∏",
      kcal: 640,
      p: 42,
      f: 12,
      c: 88,
      ingredients: [
        { name: "—Ç—É–Ω–µ—Ü –∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π", qty: 1, unit: "–±–∞–Ω" },
        { name: "–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å", qty: 350, unit: "–≥" },
        { name: "–∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ –æ–≤–æ—â–∏", qty: 250, unit: "–≥" },
        { name: "–ª–∏–º–æ–Ω", qty: 0.25, unit: "—à—Ç" },
      ],
    },
  ],
  dinner: [
    {
      name: "–†—ã–±–∞ + –≥—Ä–µ—á–∫–∞ + –æ–≤–æ—â–∏",
      kcal: 590,
      p: 40,
      f: 18,
      c: 62,
      ingredients: [
        { name: "—Ä—ã–±–∞ (–ª–æ—Å–æ—Å—å/—Ö–µ–∫)", qty: 170, unit: "–≥" },
        { name: "–≥—Ä–µ—á–∫–∞", qty: 70, unit: "–≥" },
        { name: "–±—Ä–æ–∫–∫–æ–ª–∏ (–∑–∞–º–æ—Ä.)", qty: 250, unit: "–≥" },
        { name: "–ª–∏–º–æ–Ω", qty: 0.25, unit: "—à—Ç" },
      ],
    },
    {
      name: "–ò–Ω–¥–µ–π–∫–∞ + –ø–∞—Å—Ç–∞ + —Å–æ—É—Å —Ç–æ–º–∞—Ç–Ω—ã–π",
      kcal: 620,
      p: 42,
      f: 16,
      c: 78,
      ingredients: [
        { name: "—Ñ–∞—Ä—à –∏–Ω–¥–µ–π–∫–∏", qty: 170, unit: "–≥" },
        { name: "–ø–∞—Å—Ç–∞ –∏–∑ —Ç–≤—ë—Ä–¥. —Å–æ—Ä—Ç–æ–≤", qty: 80, unit: "–≥" },
        { name: "—Ç–æ–º–∞—Ç–Ω—ã–π —Å–æ—É—Å", qty: 120, unit: "–≥" },
        { name: "–ª—É–∫", qty: 60, unit: "–≥" },
        { name: "—á–µ—Å–Ω–æ–∫", qty: 0.2, unit: "–≥–æ–ª" },
      ],
    },
  ],
  snack: [
    {
      name: "–¢–≤–æ—Ä–æ–≥ + —Ñ—Ä—É–∫—Ç—ã",
      kcal: 300,
      p: 28,
      f: 6,
      c: 32,
      ingredients: [
        { name: "—Ç–≤–æ—Ä–æ–≥ 2‚Äì5%", qty: 200, unit: "–≥" },
        { name: "–±–∞–Ω–∞–Ω—ã", qty: 0.5, unit: "—à—Ç" },
        { name: "—è–±–ª–æ–∫–∏", qty: 1, unit: "—à—Ç" },
      ],
    },
    {
      name: "–û—Ä–µ—Ö–∏ + –∫–µ—Ñ–∏—Ä",
      kcal: 320,
      p: 14,
      f: 18,
      c: 22,
      ingredients: [
        { name: "–æ—Ä–µ—Ö–∏ –∞—Å—Å–æ—Ä—Ç–∏", qty: 25, unit: "–≥" },
        { name: "–∫–µ—Ñ–∏—Ä", qty: 300, unit: "–º–ª" },
      ],
    },
  ],
};

function pickMeal(libraryArray: Meal[], seed: number) {
  if (!libraryArray?.length) return null;
  const idx = Math.abs(seed) % libraryArray.length;
  return libraryArray[idx];
}

function scaleMeal(meal: Meal | null, factor: number) {
  if (!meal) return null;
  const f = clamp(Number(factor) || 1, 0.6, 1.6);
  return {
    ...meal,
    scale: f,
    kcal: Math.round(meal.kcal * f),
    p: Math.round(meal.p * f),
    f: Math.round(meal.f * f),
    c: Math.round(meal.c * f),
    ingredients: (meal.ingredients || []).map((ing) => ({
      ...ing,
      qty: (Number(ing.qty) || 0) * f,
    })),
  };
}

type PlannedMeal = ReturnType<typeof scaleMeal> & { slot: string };

type PlannedDay = {
  day: string;
  dateISO: string;
  meals: PlannedMeal[];
  totals: { kcal: number; p: number; f: number; c: number };
  scale: number;
};

function generateWeeklyMenu({ caloriesTarget, seed = 1, weekStartISO }: { caloriesTarget: number; seed?: number; weekStartISO: string }) {
  const kcalTarget = Number(caloriesTarget) || 2000;
  const days: PlannedDay[] = [];
  const labels = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"];

  for (let i = 0; i < 7; i++) {
    const b0 = pickMeal(FOOD_LIBRARY.breakfast, seed + i);
    const l0 = pickMeal(FOOD_LIBRARY.lunch, seed + i + 10);
    const d0 = pickMeal(FOOD_LIBRARY.dinner, seed + i + 20);
    const s0 = pickMeal(FOOD_LIBRARY.snack, seed + i + 30);

    const baseTotal = (b0?.kcal || 0) + (l0?.kcal || 0) + (d0?.kcal || 0) + (s0?.kcal || 0);
    const factor = baseTotal ? clamp(kcalTarget / baseTotal, 0.8, 1.25) : 1;

    const b = scaleMeal(b0, factor);
    const l = scaleMeal(l0, factor);
    const d = scaleMeal(d0, factor);
    const s = scaleMeal(s0, factor);

    const total = (b?.kcal || 0) + (l?.kcal || 0) + (d?.kcal || 0) + (s?.kcal || 0);
    const p = (b?.p || 0) + (l?.p || 0) + (d?.p || 0) + (s?.p || 0);
    const f = (b?.f || 0) + (l?.f || 0) + (d?.f || 0) + (s?.f || 0);
    const c = (b?.c || 0) + (l?.c || 0) + (d?.c || 0) + (s?.c || 0);

    const dateISO = addDaysISO(weekStartISO, i);

    days.push({
      day: labels[i],
      dateISO,
      meals: [
        b ? ({ slot: "–ó–∞–≤—Ç—Ä–∞–∫", ...b } as PlannedMeal) : null,
        l ? ({ slot: "–û–±–µ–¥", ...l } as PlannedMeal) : null,
        d ? ({ slot: "–£–∂–∏–Ω", ...d } as PlannedMeal) : null,
        s ? ({ slot: "–ü–µ—Ä–µ–∫—É—Å", ...s } as PlannedMeal) : null,
      ].filter(Boolean) as PlannedMeal[],
      totals: { kcal: total, p, f, c },
      scale: factor,
    });
  }
  return days;
}

function mergeShoppingItems(items: Ingredient[]) {
  const map = new Map<string, Ingredient>();
  for (const it of items) {
    const key = `${it.name}__${it.unit}`;
    const prev = map.get(key);
    map.set(key, { ...it, qty: (prev?.qty || 0) + (Number(it.qty) || 0) });
  }
  return Array.from(map.values()).sort((a, b) => a.name.localeCompare(b.name, "ru"));
}

function buildShoppingList(menu: PlannedDay[]) {
  const all: Ingredient[] = [];
  for (const day of menu || []) {
    for (const meal of day.meals || []) {
      for (const it of meal.ingredients || []) all.push(it);
    }
  }
  return mergeShoppingItems(all);
}

// -----------------------------
// Exercises
// -----------------------------

const EQUIPMENT = [
  { id: "none", label: "–ë–µ–∑ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" },
  { id: "dumbbells", label: "–ì–∞–Ω—Ç–µ–ª–∏" },
  { id: "kettlebell", label: "–ì–∏—Ä—è" },
  { id: "bands", label: "–†–µ–∑–∏–Ω–∫–∏" },
  { id: "pullup_bar", label: "–¢—É—Ä–Ω–∏–∫" },
  { id: "bench", label: "–°–∫–∞–º—å—è" },
  { id: "barbell", label: "–®—Ç–∞–Ω–≥–∞" },
  { id: "cable", label: "–ë–ª–æ—á–Ω—ã–π —Ç—Ä–µ–Ω–∞–∂—ë—Ä" },
  { id: "machines", label: "–¢—Ä–µ–Ω–∞–∂—ë—Ä—ã" },
];

type Exercise = {
  id: string;
  name: string;
  // –û—Å–Ω–æ–≤–Ω–∞—è (–≥–ª–∞–≤–Ω–∞—è) –≥—Ä—É–ø–ø–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö –∏ –≤ –ø–ª–∞–Ω–µ
  muscle: string;
  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã ‚Äî —É—á–∞—Å—Ç–≤—É—é—Ç, –Ω–æ –Ω–µ –≥–ª–∞–≤–Ω—ã–µ
  secondaryMuscles?: string[];
  equip: string[];
  tags?: string[];
};

const EXERCISES: Exercise[] = [
  // Chest (primary: –ì—Ä—É–¥—å)
  { id: "pushup", name: "–û—Ç–∂–∏–º–∞–Ω–∏—è", muscle: "–ì—Ä—É–¥—å", secondaryMuscles: ["–ü–ª–µ—á–∏", "–†—É–∫–∏", "–ö–æ—Ä"], equip: ["none"], tags: ["–±–∞–∑–∞"] },
  { id: "db_bench", name: "–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞", muscle: "–ì—Ä—É–¥—å", secondaryMuscles: ["–ü–ª–µ—á–∏", "–†—É–∫–∏"], equip: ["dumbbells", "bench"] },
  { id: "bb_bench", name: "–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª—ë–∂–∞", muscle: "–ì—Ä—É–¥—å", secondaryMuscles: ["–ü–ª–µ—á–∏", "–†—É–∫–∏"], equip: ["barbell", "bench"] },
  { id: "cable_fly", name: "–°–≤–µ–¥–µ–Ω–∏—è –≤ –∫—Ä–æ—Å—Å–æ–≤–µ—Ä–µ", muscle: "–ì—Ä—É–¥—å", secondaryMuscles: ["–ü–ª–µ—á–∏"], equip: ["cable"] },

  // Back (primary: –°–ø–∏–Ω–∞)
  { id: "pullup", name: "–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è", muscle: "–°–ø–∏–Ω–∞", secondaryMuscles: ["–†—É–∫–∏", "–ö–æ—Ä"], equip: ["pullup_bar"], tags: ["–±–∞–∑–∞"] },
  { id: "row_db", name: "–¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ", muscle: "–°–ø–∏–Ω–∞", secondaryMuscles: ["–†—É–∫–∏", "–ö–æ—Ä"], equip: ["dumbbells"] },
  { id: "lat_pulldown", name: "–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞", muscle: "–°–ø–∏–Ω–∞", secondaryMuscles: ["–†—É–∫–∏"], equip: ["cable"] },
  { id: "inverted_row", name: "–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Ç—è–≥–∞ (–ø–æ–¥ —Å—Ç–æ–ª–æ–º/–≤ –ø–µ—Ç–ª—è—Ö)", muscle: "–°–ø–∏–Ω–∞", secondaryMuscles: ["–†—É–∫–∏", "–ö–æ—Ä"], equip: ["none"], tags: ["–¥–æ–º"] },

  // Legs (primary: –ù–æ–≥–∏)
  { id: "squat_bw", name: "–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è (–≤–µ—Å —Ç–µ–ª–∞)", muscle: "–ù–æ–≥–∏", secondaryMuscles: ["–ö–æ—Ä"], equip: ["none"] },
  { id: "goblet", name: "–ì–æ–±–ª–µ—Ç-–ø—Ä–∏—Å–µ–¥", muscle: "–ù–æ–≥–∏", secondaryMuscles: ["–ö–æ—Ä"], equip: ["dumbbells", "kettlebell"] },
  { id: "bb_squat", name: "–ü—Ä–∏—Å–µ–¥ —Å–æ —à—Ç–∞–Ω–≥–æ–π", muscle: "–ù–æ–≥–∏", secondaryMuscles: ["–ö–æ—Ä"], equip: ["barbell"] },
  { id: "leg_press", name: "–ñ–∏–º –Ω–æ–≥–∞–º–∏", muscle: "–ù–æ–≥–∏", secondaryMuscles: ["–ö–æ—Ä"], equip: ["machines"] },
  // –†—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞: –Ω–æ–≥–∏/–∑–∞–¥–Ω—è—è —Ü–µ–ø—å, –Ω–æ —Å–ø–∏–Ω–∞/–∫–æ—Ä –¥–µ—Ä–∂–∞—Ç –∫–æ—Ä–ø—É—Å
  { id: "rdl_db", name: "–†—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞ (–≥–∞–Ω—Ç–µ–ª–∏)", muscle: "–ù–æ–≥–∏", secondaryMuscles: ["–°–ø–∏–Ω–∞", "–ö–æ—Ä"], equip: ["dumbbells"] },

  // Shoulders (primary: –ü–ª–µ—á–∏)
  { id: "pike_push", name: "–û—Ç–∂–∏–º–∞–Ω–∏—è —É–≥–æ–ª–∫–æ–º", muscle: "–ü–ª–µ—á–∏", secondaryMuscles: ["–†—É–∫–∏", "–ö–æ—Ä"], equip: ["none"] },
  { id: "ohp_db", name: "–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π", muscle: "–ü–ª–µ—á–∏", secondaryMuscles: ["–†—É–∫–∏", "–ö–æ—Ä"], equip: ["dumbbells"] },
  { id: "ohp_bb", name: "–ñ–∏–º —à—Ç–∞–Ω–≥–∏ —Å—Ç–æ—è", muscle: "–ü–ª–µ—á–∏", secondaryMuscles: ["–†—É–∫–∏", "–ö–æ—Ä"], equip: ["barbell"] },
  { id: "lateral_raise", name: "–†–∞–∑–≤–µ–¥–µ–Ω–∏—è –≥–∞–Ω—Ç–µ–ª–µ–π –≤ —Å—Ç–æ—Ä–æ–Ω—ã", muscle: "–ü–ª–µ—á–∏", secondaryMuscles: [], equip: ["dumbbells"] },

  // Arms (primary: –†—É–∫–∏)
  { id: "curl_db", name: "–°–≥–∏–±–∞–Ω–∏—è –Ω–∞ –±–∏—Ü–µ–ø—Å (–≥–∞–Ω—Ç–µ–ª–∏)", muscle: "–†—É–∫–∏", secondaryMuscles: [], equip: ["dumbbells"] },
  { id: "curl_band", name: "–°–≥–∏–±–∞–Ω–∏—è –Ω–∞ –±–∏—Ü–µ–ø—Å (—Ä–µ–∑–∏–Ω–∫–∞)", muscle: "–†—É–∫–∏", secondaryMuscles: [], equip: ["bands"] },
  // –î–∏–ø—ã: –æ–±—ã—á–Ω–æ —Ç—Ä–∏—Ü–µ–ø—Å/–≥—Ä—É–¥—å/–ø–ª–µ—á–∏ ‚Äî —É–ø—Ä–æ—Å—Ç–∏–º: —Ä—É–∫–∏ –≥–ª–∞–≤–Ω—ã–µ
  { id: "triceps_dip", name: "–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö/—Å—Ç—É–ª–µ", muscle: "–†—É–∫–∏", secondaryMuscles: ["–ì—Ä—É–¥—å", "–ü–ª–µ—á–∏"], equip: ["none", "bench"] },
  { id: "pushdown", name: "–†–∞–∑–≥–∏–±–∞–Ω–∏—è –Ω–∞ –±–ª–æ–∫–µ", muscle: "–†—É–∫–∏", secondaryMuscles: [], equip: ["cable"] },

  // Core (primary: –ö–æ—Ä)
  { id: "plank", name: "–ü–ª–∞–Ω–∫–∞", muscle: "–ö–æ—Ä", secondaryMuscles: [], equip: ["none"] },
  { id: "dead_bug", name: "Dead bug", muscle: "–ö–æ—Ä", secondaryMuscles: [], equip: ["none"] },
  { id: "hanging_knees", name: "–ü–æ–¥—ä—ë–º –∫–æ–ª–µ–Ω–µ–π –≤ –≤–∏—Å–µ", muscle: "–ö–æ—Ä", secondaryMuscles: ["–†—É–∫–∏"], equip: ["pullup_bar"] },
];

const SUBSTITUTIONS: Record<string, Array<{ need: string; alt: string }>> = {
  pullup_bar: [
    { need: "pullup", alt: "lat_pulldown" },
    { need: "pullup", alt: "inverted_row" },
    { need: "hanging_knees", alt: "dead_bug" },
  ],
  bench: [
    { need: "db_bench", alt: "pushup" },
    { need: "bb_bench", alt: "pushup" },
    { need: "triceps_dip", alt: "pushdown" },
  ],
  barbell: [
    { need: "bb_bench", alt: "db_bench" },
    { need: "bb_squat", alt: "goblet" },
    { need: "ohp_bb", alt: "ohp_db" },
  ],
  cable: [
    { need: "lat_pulldown", alt: "row_db" },
    { need: "cable_fly", alt: "pushup" },
    { need: "pushdown", alt: "triceps_dip" },
  ],
};

function hasAllEquipment(exercise: Exercise, available: Set<string>) {
  if (!exercise?.equip?.length) return true;
  if (exercise.equip.includes("none")) return true;
  return exercise.equip.every((e) => available.has(e));
}

function resolveExercise(exId: string) {
  return EXERCISES.find((e) => e.id === exId) || null;
}

function suggestSubstitutions({ exercise, available }: { exercise: Exercise; available: Set<string> }) {
  const missing = (exercise?.equip || []).filter((e) => e !== "none" && !available.has(e));
  const suggestions: Exercise[] = [];

  for (const m of missing) {
    for (const rule of SUBSTITUTIONS[m] || []) {
      if (rule.need === exercise.id) {
        const alt = resolveExercise(rule.alt);
        if (alt && hasAllEquipment(alt, available)) suggestions.push(alt);
      }
    }
  }

  if (!suggestions.length && exercise) {
    const same = EXERCISES.filter((e) => e.muscle === exercise.muscle && hasAllEquipment(e, available));
    suggestions.push(...same.slice(0, 2));
  }

  return Array.from(new Map(suggestions.map((s) => [s.id, s])).values());
}

function buildWorkoutPlan({
  daysPerWeek,
  location,
  availableEquipment,
  focus,
  cardioDays,
}: {
  daysPerWeek: number;
  location: string;
  availableEquipment: string[];
  focus: string;
  cardioDays: number;
}) {
  const days = clamp(Number(daysPerWeek) || 3, 2, 6);
  const available = new Set(availableEquipment);
  if (location === "gym") {
    ["cable", "machines", "bench", "barbell", "dumbbells"].forEach((x) => available.add(x));
  }

  const pool = EXERCISES.filter((e) => hasAllEquipment(e, available));

  const byMuscle: Record<string, Exercise[]> = {
    "–ì—Ä—É–¥—å": pool.filter((e) => e.muscle === "–ì—Ä—É–¥—å"),
    "–°–ø–∏–Ω–∞": pool.filter((e) => e.muscle === "–°–ø–∏–Ω–∞"),
    "–ù–æ–≥–∏": pool.filter((e) => e.muscle === "–ù–æ–≥–∏"),
    "–ü–ª–µ—á–∏": pool.filter((e) => e.muscle === "–ü–ª–µ—á–∏"),
    "–†—É–∫–∏": pool.filter((e) => e.muscle === "–†—É–∫–∏"),
    "–ö–æ—Ä": pool.filter((e) => e.muscle === "–ö–æ—Ä"),
  };

  const pick = (arr: Exercise[], n: number, seed = 0) => {
    const out: Exercise[] = [];
    if (!arr?.length) return out;
    for (let i = 0; i < n; i++) out.push(arr[(i + seed) % arr.length]);
    return out;
  };

  const sessions: Array<{ title: string; exercises: Array<Exercise & { prescription: string; rest: string }> }> = [];

  const makeSession = (title: string, muscles: string[], seedBase: number) => {
    const items: Exercise[] = [];
    for (const m of muscles) {
      const count = m === "–ù–æ–≥–∏" ? 2 : 1;
      items.push(...pick(byMuscle[m] || [], count, seedBase + m.length));
    }
    items.push(...pick(byMuscle["–ö–æ—Ä"] || [], 1, seedBase + 99));

    const uniq = Array.from(new Map(items.map((x) => [x.id, x])).values());

    const setRep = (ex: Exercise) => {
      const isBase = ex.tags?.includes("–±–∞–∑–∞");
      if (focus === "fat_loss") return isBase ? "3√ó6‚Äì10" : "3√ó10‚Äì15";
      return isBase ? "4√ó5‚Äì8" : "3√ó8‚Äì12";
    };

    const list = uniq.slice(0, 7).map((ex) => ({
      ...ex,
      prescription: setRep(ex),
      rest: focus === "fat_loss" ? "60‚Äì90—Å" : "90‚Äì150—Å",
    }));

    return { title, exercises: list };
  };

  if (days <= 3) {
    const template = [
      { title: "Full Body A", muscles: ["–ù–æ–≥–∏", "–ì—Ä—É–¥—å", "–°–ø–∏–Ω–∞", "–ü–ª–µ—á–∏", "–†—É–∫–∏"] },
      { title: "Full Body B", muscles: ["–ù–æ–≥–∏", "–°–ø–∏–Ω–∞", "–ì—Ä—É–¥—å", "–ü–ª–µ—á–∏", "–†—É–∫–∏"] },
      { title: "Full Body C", muscles: ["–ù–æ–≥–∏", "–ì—Ä—É–¥—å", "–°–ø–∏–Ω–∞", "–ü–ª–µ—á–∏", "–†—É–∫–∏"] },
    ];
    for (let i = 0; i < days; i++) sessions.push(makeSession(template[i].title, template[i].muscles, i * 7));
  } else if (days === 4) {
    const template = [
      { title: "Upper", muscles: ["–ì—Ä—É–¥—å", "–°–ø–∏–Ω–∞", "–ü–ª–µ—á–∏", "–†—É–∫–∏"] },
      { title: "Lower", muscles: ["–ù–æ–≥–∏", "–ö–æ—Ä"] },
      { title: "Upper", muscles: ["–ì—Ä—É–¥—å", "–°–ø–∏–Ω–∞", "–ü–ª–µ—á–∏", "–†—É–∫–∏"] },
      { title: "Lower", muscles: ["–ù–æ–≥–∏", "–ö–æ—Ä"] },
    ];
    template.forEach((t, i) => sessions.push(makeSession(`${t.title} ${i % 2 ? "B" : "A"}`, t.muscles, i * 11)));
  } else {
    const template = [
      { title: "Push", muscles: ["–ì—Ä—É–¥—å", "–ü–ª–µ—á–∏", "–†—É–∫–∏"] },
      { title: "Pull", muscles: ["–°–ø–∏–Ω–∞", "–†—É–∫–∏"] },
      { title: "Legs", muscles: ["–ù–æ–≥–∏"] },
      { title: "Push", muscles: ["–ì—Ä—É–¥—å", "–ü–ª–µ—á–∏", "–†—É–∫–∏"] },
      { title: "Pull", muscles: ["–°–ø–∏–Ω–∞", "–†—É–∫–∏"] },
      { title: "Legs", muscles: ["–ù–æ–≥–∏"] },
    ];
    for (let i = 0; i < days; i++) {
      const t = template[i];
      sessions.push(makeSession(`${t.title} ${i < 3 ? "A" : "B"}`, t.muscles, i * 13));
    }
  }

  const cDays = clamp(Number(cardioDays) || 0, 0, 6);
  const cardio = {
    recommendation:
      focus === "fat_loss"
        ? "20‚Äì35 –º–∏–Ω LISS (–±—ã—Å—Ç—Ä–∞—è —Ö–æ–¥—å–±–∞/–≤–µ–ª–æ) –∏–ª–∏ 10‚Äì15 –º–∏–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã 1‚Äì2 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é."
        : "10‚Äì25 –º–∏–Ω –ª—ë–≥–∫–æ–µ –∫–∞—Ä–¥–∏–æ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.",
    days: cDays,
  };

  return { sessions, cardio, assumptions: { location, available: Array.from(available) } };
}

// -----------------------------
// Tracker helpers
// -----------------------------

function parsePrescription(p: string) {
  const s = String(p || "").trim();
  const m = s.match(/([0-9]+)[ ]*[x√ó][ ]*([0-9]+)[ ]*[‚Äì-][ ]*([0-9]+)/i);
  if (!m) return { sets: 3, minReps: 8, maxReps: 12 };
  return { sets: Number(m[1]) || 3, minReps: Number(m[2]) || 8, maxReps: Number(m[3]) || 12 };
}

function incrementForExercise(ex: Exercise) {
  const eq = new Set(ex?.equip || []);
  if (eq.has("barbell")) return 2.5;
  if (eq.has("dumbbells") || eq.has("kettlebell")) return 1;
  if (eq.has("cable") || eq.has("machines")) return 2.5;
  return 0;
}

type WorkoutEntrySet = { reps: number | null; weight: number | null };

type WorkoutLog = {
  id: string;
  dateISO: string;
  sessionTitle: string;
  sessionIdx: number;
  entries: Array<{ exerciseId: string; prescription: string; sets: WorkoutEntrySet[] }>;
};

function lastLogForExercise(workoutLogs: WorkoutLog[], exerciseId: string) {
  const logs = (workoutLogs || []).slice().sort((a, b) => String(b.dateISO).localeCompare(String(a.dateISO)));
  for (const log of logs) {
    const entry = (log.entries || []).find((x) => x.exerciseId === exerciseId);
    if (entry) return { log, entry };
  }
  return null;
}

function progressionHint({ ex, prescription, lastEntry }: { ex: Exercise; prescription: string; lastEntry: any }) {
  const { minReps, maxReps } = parsePrescription(prescription);
  const inc = incrementForExercise(ex);

  if (!lastEntry?.sets?.length) {
    return { title: "–°—Ç–∞—Ä—Ç", detail: `–ù–∞—á–Ω–∏ —Å –≤–µ—Å–∞/–≤–∞—Ä–∏–∞–Ω—Ç–∞, –≥–¥–µ –¥–µ–ª–∞–µ—à—å ${minReps}‚Äì${maxReps} –≤ –∫–∞–∂–¥–æ–º –ø–æ–¥—Ö–æ–¥–µ.` };
  }

  const reps = (lastEntry.sets || []).map((s: any) => Number(s.reps) || 0).filter((r: number) => r > 0);
  const weights = (lastEntry.sets || []).map((s: any) => Number(s.weight) || 0);
  const w = Math.max(...weights, 0);

  if (!reps.length) return { title: "–ü—Ä–æ–¥–æ–ª–∂–∞–π", detail: `–¶–µ–ª—å: ${minReps}‚Äì${maxReps} –ø–æ–≤—Ç–æ—Ä–æ–≤.` };

  const allAtTop = reps.every((r: number) => r >= maxReps);
  const anyBelowMin = reps.some((r: number) => r < minReps);

  if (inc === 0) {
    if (allAtTop) return { title: "–ü—Ä–æ–≥—Ä–µ—Å—Å", detail: "–î–æ–±–∞–≤—å +1‚Äì2 –ø–æ–≤—Ç–æ—Ä–∞ –Ω–∞ –ø–æ–¥—Ö–æ–¥ –∏–ª–∏ —É—Å–ª–æ–∂–Ω–∏ –≤–∞—Ä–∏–∞–Ω—Ç." };
    if (anyBelowMin) return { title: "–°—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–π", detail: `–û—Å—Ç–∞–≤—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å, –¥–æ–±–µ–π—Å—è ${minReps}+ –≤ –∫–∞–∂–¥–æ–º –ø–æ–¥—Ö–æ–¥–µ.` };
    return { title: "–î–æ–±–∞–≤–ª—è–π –ø–æ–≤—Ç–æ—Ä—ã", detail: `–î–æ—Ç—è–Ω–∏ –¥–æ ${maxReps} –≤–æ –≤—Å–µ—Ö –ø–æ–¥—Ö–æ–¥–∞—Ö ‚Üí —É—Å–ª–æ–∂–Ω—è–π.` };
  }

  if (allAtTop) {
    const next = w ? w + inc : inc;
    return { title: "–ü–æ–≤—ã—à–∞–π –≤–µ—Å", detail: `–°–¥–µ–ª–∞–ª –≤–µ—Ä—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–∞ ‚Üí –ø–æ–ø—Ä–æ–±—É–π ${next} –∫–≥ (–∏–ª–∏ +${inc}–∫–≥).` };
  }
  if (anyBelowMin) {
    const next = w ? Math.max(0, w - inc) : 0;
    return { title: "–°–Ω–∏–∑—å/–æ—Å—Ç–∞–≤—å", detail: `–ï—Å–ª–∏ —Ç—è–∂–µ–ª–æ: –æ—Å—Ç–∞–≤—å –≤–µ—Å –∏–ª–∏ —Å–Ω–∏–∑—å –¥–æ ${next} –∫–≥, —Ü–µ–ª—å ${minReps}+.` };
  }
  return { title: "–î–æ–±–∞–≤–ª—è–π –ø–æ–≤—Ç–æ—Ä—ã", detail: `–î–æ–≤–µ–¥–∏ –¥–æ ${maxReps} –≤–æ –≤—Å–µ—Ö –ø–æ–¥—Ö–æ–¥–∞—Ö ‚Üí –∑–∞—Ç–µ–º +${inc}–∫–≥.` };
}

function workoutLogsInRange(logs: WorkoutLog[], startISO: string, endISO: string) {
  return (logs || []).filter((l) => String(l.dateISO) >= String(startISO) && String(l.dateISO) <= String(endISO));
}

function computeWeeklyMuscleUsage(logs: WorkoutLog[], startISO: string) {
  const endISO = addDaysISO(startISO, 6);
  const week = workoutLogsInRange(logs, startISO, endISO);

  // –°—á–∏—Ç–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ: –≥–ª–∞–≤–Ω—ã–µ –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ.
  // –ò—Ç–æ–≥–æ–≤—ã–π score –Ω—É–∂–µ–Ω –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏/–¥–æ–ª–∏.
  // –í–∞–∂–Ω–æ: —ç—Ç–æ ¬´–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è¬ª –º–µ—Ç—Ä–∏–∫–∞ ‚Äî –Ω–µ —Ä–µ–∞–ª—å–Ω–∞—è —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—è.
  const map = new Map<string, { primary: number; secondary: number }>();

  const add = (muscle: string, kind: "primary" | "secondary", amount: number) => {
    if (!muscle || amount <= 0) return;
    const cur = map.get(muscle) || { primary: 0, secondary: 0 };
    cur[kind] += amount;
    map.set(muscle, cur);
  };

  for (const l of week) {
    for (const e of l.entries || []) {
      const ex = resolveExercise(e.exerciseId);
      if (!ex) continue;
      const setsDone = (e.sets || []).filter((s) => s.reps !== null && s.reps !== undefined).length;
      const setsCount = setsDone || (e.sets || []).length || 0;
      if (!setsCount) continue;

      add(ex.muscle || "–î—Ä—É–≥–æ–µ", "primary", setsCount);
      for (const sm of ex.secondaryMuscles || []) add(sm, "secondary", setsCount);
    }
  }

  // –í–µ—Å–∞: –≥–ª–∞–≤–Ω–∞—è 1.0, –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è 0.5
  const out = Array.from(map.entries())
    .map(([muscle, v]) => ({ muscle, primarySets: v.primary, secondarySets: v.secondary, score: v.primary + v.secondary * 0.5 }))
    .sort((a, b) => b.score - a.score);

  return { startISO, endISO, data: out };
}

// -----------------------------
// UI helpers
// -----------------------------

function useLocalStorageState<T>(key: string, initial: T): [T, React.Dispatch<React.SetStateAction<T>>] {
  const [state, setState] = useState<T>(() => {
    try {
      const raw = localStorage.getItem(key);
      return raw ? ({ ...initial, ...(JSON.parse(raw) as any) } as T) : initial;
    } catch {
      return initial;
    }
  });

  useEffect(() => {
    try {
      localStorage.setItem(key, JSON.stringify(state));
    } catch {
      // ignore
    }
  }, [key, state]);

  return [state, setState];
}

function Field({ label, hint, children }: { label: string; hint?: string; children: React.ReactNode }) {
  return (
    <div className="grid gap-2">
      <div className="flex items-end justify-between gap-3">
        <Label className="text-sm">{label}</Label>
        {hint ? <div className="text-xs text-muted-foreground">{hint}</div> : null}
      </div>
      {children}
    </div>
  );
}

function svgDataUri(svg: string) {
  return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
}

function placeholderExerciseImage(ex: Exercise) {
  const title = (ex?.name || "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ").slice(0, 26);
  const sub = `${ex?.muscle || ""}${ex?.secondaryMuscles?.length ? ` + ${ex.secondaryMuscles.slice(0, 2).join(", ")}` : ""}`;
  const safe = (s: string) => s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  // –ü—Ä–æ—Å—Ç–∞—è –æ—Ñ—Ñ–ª–∞–π–Ω-—Å—Ö–µ–º–∞. –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —á–µ—Ä–µ–∑ URL.
  const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="640" height="400" viewBox="0 0 640 400">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0" stop-color="#ffffff"/>
      <stop offset="1" stop-color="#f4f4f5"/>
    </linearGradient>
  </defs>
  <rect x="0" y="0" width="640" height="400" rx="28" fill="url(#g)" stroke="#e4e4e7"/>
  <g fill="none" stroke="#111827" stroke-width="10" stroke-linecap="round" stroke-linejoin="round" opacity="0.9">
    <circle cx="170" cy="140" r="28"/>
    <path d="M170 170 L170 250" />
    <path d="M170 200 L120 230" />
    <path d="M170 200 L220 230" />
    <path d="M170 250 L130 320" />
    <path d="M170 250 L220 320" />
    <path d="M260 310 L520 310" opacity="0.35" />
  </g>
  <text x="320" y="105" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-size="28" fill="#111827" font-weight="700">${safe(title)}</text>
  <text x="320" y="145" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-size="16" fill="#52525b">${safe(sub)}</text>
  <text x="320" y="370" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-size="14" fill="#71717a">(–°—Ö–µ–º–∞. –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ñ–æ—Ç–æ)</text>
</svg>`;
  return svgDataUri(svg);
}

function getExerciseImage(data: UserState, ex: Exercise) {
  const override = data?.library?.exerciseMedia?.[ex.id];
  return override || placeholderExerciseImage(ex);
}

function isVideoSrc(src: string) {
  const s = String(src || "").toLowerCase();
  return (
    s.startsWith("data:video/") ||
    s.endsWith(".mp4") ||
    s.endsWith(".webm") ||
    s.endsWith(".mov") ||
    s.includes(".mp4?") ||
    s.includes(".webm?") ||
    s.includes(".mov?")
  );
}

function ExerciseMedia({
  src,
  alt,
  className,
  mode,
}: {
  src: string;
  alt: string;
  className: string;
  mode: "thumb" | "full";
}) {
  if (isVideoSrc(src)) {
    return (
      <video
        className={className}
        src={src}
        muted
        loop
        playsInline
        autoPlay={mode === "thumb"}
        controls={mode === "full"}
      />
    );
  }
  // GIF ‚Äî —ç—Ç–æ –æ–±—ã—á–Ω—ã–π img, –±—É–¥–µ—Ç –∞–Ω–∏–º–∏—Ä–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  return <img src={src} alt={alt} className={className} />;
}

function StatPill({ title, value, sub }: { title: string; value: string; sub?: string }) {
  return (
    <div className="rounded-2xl border bg-background/50 p-3 shadow-sm">
      <div className="text-xs text-muted-foreground">{title}</div>
      <div className="text-lg font-semibold leading-tight">{value}</div>
      {sub ? <div className="text-xs text-muted-foreground mt-1">{sub}</div> : null}
    </div>
  );
}

// -----------------------------
// Multi-user data model
// -----------------------------

type NutritionActualMeal = {
  eaten: boolean;
  name: string;
  kcal: number;
  p: number;
  f: number;
  c: number;
  foods?: MealFoodEntry[]; // –µ—Å–ª–∏ —Å–æ–±—Ä–∞–ª –∏–∑ –±–∞–∑—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤
};

type UserState = {
  profile: { sex: string; age: number; heightCm: number; weightKg: number; activity: string };
  goal: { loseKg: number; pace: string; focus: string };
  training: {
    location: string;
    daysPerWeek: number;
    cardioDays: number;
    homeEquipment: Record<string, boolean>;
    notes: string;
  };
  nutrition: {
    seed: number;
    weekStartISO: string;
    actual: Record<string, { meals: Record<string, NutritionActualMeal> }>;
  };
  progress: { logs: Array<any> };
  workouts: { logs: WorkoutLog[] };
  // –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞: –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π (URL –∏–ª–∏ data:image/...)
  library: {
    exerciseMedia: Record<string, string>;
  };
};

type AppState = {
  activeUserId: string;
  users: Array<{ id: string; name: string; state: UserState }>;
};

function makeDefaultUserState(): UserState {
  return {
    profile: {
      sex: "male",
      age: 28,
      heightCm: 178,
      weightKg: 82,
      activity: "moderate",
    },
    goal: {
      loseKg: 6,
      pace: "normal",
      focus: "fat_loss", // fat_loss | strength
    },
    training: {
      location: "gym",
      daysPerWeek: 4,
      cardioDays: 2,
      homeEquipment: {
        none: true,
        dumbbells: true,
        kettlebell: false,
        bands: true,
        pullup_bar: false,
        bench: false,
        barbell: false,
        cable: false,
        machines: false,
      },
      notes: "",
    },
    nutrition: {
      seed: 7,
      weekStartISO: weekStartMondayISO(),
      actual: {},
    },
    progress: {
      logs: [],
    },
    workouts: {
      logs: [],
    },
    library: {
      exerciseMedia: {},
    },
  };
}

function makeId() {
  return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
}

// -----------------------------
// Workouts: tracker component
// -----------------------------

function WorkoutTracker({ data, setData, workoutPlan }: { data: UserState; setData: any; workoutPlan: any }) {
  const [sessionIdx, setSessionIdx] = useState(0);
  const [dateISO, setDateISO] = useState(() => toISODateLocal(new Date()));
  const [draft, setDraft] = useState<Record<string, { sets: Array<{ reps: any; weight: any }> }>>({});

  const sessions = workoutPlan?.sessions || [];
  const session = sessions[sessionIdx] || sessions[0];

  useEffect(() => {
    if (!session) return;
    const next: Record<string, { sets: Array<{ reps: any; weight: any }> }> = {};
    for (const ex of session.exercises || []) {
      const pr = parsePrescription(ex.prescription);
      const last = lastLogForExercise(data.workouts?.logs || [], ex.id);
      const lastSets = last?.entry?.sets || [];
      next[ex.id] = {
        sets: Array.from({ length: pr.sets }).map((_, i) => ({
          reps: lastSets[i]?.reps ?? "",
          weight: lastSets[i]?.weight ?? "",
        })),
      };
    }
    setDraft(next);
  }, [sessionIdx, workoutPlan]);

  const saveWorkout = () => {
    if (!session) return;

    const entries = (session.exercises || []).map((ex: any) => {
      const sets = (draft?.[ex.id]?.sets || []).map((s) => ({
        reps: s.reps === "" ? null : Number(s.reps),
        weight: s.weight === "" ? null : Number(s.weight),
      }));
      return { exerciseId: ex.id, prescription: ex.prescription, sets };
    });

    const log: WorkoutLog = {
      id: `${dateISO}__${session.title}__${sessionIdx}`,
      dateISO,
      sessionTitle: session.title,
      sessionIdx,
      entries,
    };

    setData((d: UserState) => {
      const prev = d.workouts?.logs || [];
      const filtered = prev.filter((x) => x.id !== log.id);
      return { ...d, workouts: { ...d.workouts, logs: [log, ...filtered] } };
    });
  };

  const logs = useMemo(
    () => (data.workouts?.logs || []).slice().sort((a, b) => String(b.dateISO).localeCompare(String(a.dateISO))),
    [data.workouts?.logs]
  );

  return (
    <div className="grid gap-4">
      <div className="grid gap-4 md:grid-cols-3">
        <Card className="rounded-2xl shadow-sm md:col-span-2">
          <CardHeader>
            <CardTitle>–ó–∞–ø–∏—Å–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</CardTitle>
          </CardHeader>
          <CardContent className="grid gap-4">
            <div className="grid gap-4 sm:grid-cols-3">
              <Field label="–î–∞—Ç–∞">
                <Input className="rounded-xl" type="date" value={dateISO} onChange={(e) => setDateISO(e.target.value)} />
              </Field>
              <Field label="–°–µ—Å—Å–∏—è">
                <Select value={String(sessionIdx)} onValueChange={(v) => setSessionIdx(Number(v))}>
                  <SelectTrigger className="rounded-xl">
                    <SelectValue placeholder="–í—ã–±–µ—Ä–∏" />
                  </SelectTrigger>
                  <SelectContent>
                    {sessions.map((s: any, i: number) => (
                      <SelectItem key={i} value={String(i)}>{`–î–µ–Ω—å ${i + 1}: ${s.title}`}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </Field>
              <div className="rounded-2xl border bg-muted/30 p-3">
                <div className="text-sm font-medium">–ê–≤—Ç–æ-–ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è</div>
                <div className="text-xs text-muted-foreground">–ü–æ–¥—Å–∫–∞–∑–∫–∏ ‚Äî –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.</div>
              </div>
            </div>

            {session ? (
              <div className="grid gap-3">
                {(session.exercises || []).map((ex: any) => {
                  const pr = parsePrescription(ex.prescription);
                  const last = lastLogForExercise(data.workouts?.logs || [], ex.id);
                  const hint = progressionHint({ ex, prescription: ex.prescription, lastEntry: last?.entry });
                  const usesWeight = incrementForExercise(ex) > 0;

                  return (
                    <div key={ex.id} className="rounded-2xl border p-3">
                      <div className="flex items-start justify-between gap-3">
                        <div className="flex items-start gap-3">
                          <div className="rounded-xl overflow-hidden border bg-muted/20 shrink-0">
                            <img src={getExerciseImage(data, ex)} alt={ex.name} className="h-14 w-20 object-cover" />
                          </div>
                          <div>
                            <div className="text-sm font-medium">{ex.name}</div>
                            <div className="text-xs text-muted-foreground">
                              –ì–ª–∞–≤–Ω–∞—è: {ex.muscle}
                              {ex.secondaryMuscles?.length ? ` ¬∑ –í—Å–ø–æ–º–æ–≥.: ${ex.secondaryMuscles.join(", ")}` : ""}
                              {` ¬∑ ${ex.prescription}`}
                            </div>
                          </div>
                        </div>
                          <div className="mt-2 text-xs">
                            <span className="font-medium">{hint.title}:</span> <span className="text-muted-foreground">{hint.detail}</span>
                          </div>
                          {last?.log ? (
                            <div className="mt-2 text-xs text-muted-foreground">
                              –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: {last.log.dateISO} ¬∑ {(last.entry.sets || []).map((s: any) => `${s.weight ?? "‚Äî"}–∫–≥√ó${s.reps ?? "‚Äî"}`).join(" ¬∑ ")}
                            </div>
                          ) : null}
                        </div>
                        <div className="flex flex-wrap gap-1 justify-end">
                          {(ex.equip || []).map((e: string) => (
                            <Badge key={e} variant="outline" className="rounded-xl">{EQUIPMENT.find((x) => x.id === e)?.label || e}</Badge>
                          ))}
                        </div>
                      </div>

                      <div className="mt-3 grid gap-2">
                        {Array.from({ length: pr.sets }).map((_, si) => {
                          const set = draft?.[ex.id]?.sets?.[si] || { reps: "", weight: "" };
                          return (
                            <div key={si} className="grid grid-cols-12 gap-2 items-end">
                              <div className="col-span-12 sm:col-span-2 text-sm text-muted-foreground">–ü–æ–¥—Ö–æ–¥ {si + 1}</div>
                              <div className="col-span-6 sm:col-span-5">
                                <Label className="text-xs">–ü–æ–≤—Ç–æ—Ä—ã</Label>
                                <Input
                                  className="rounded-xl"
                                  type="number"
                                  value={set.reps}
                                  onChange={(e) => {
                                    const v = e.target.value;
                                    setDraft((d) => ({
                                      ...d,
                                      [ex.id]: {
                                        sets: (d?.[ex.id]?.sets || []).map((x: any, j: number) => (j === si ? { ...x, reps: v } : x)),
                                      },
                                    }));
                                  }}
                                />
                              </div>
                              <div className="col-span-6 sm:col-span-5">
                                <Label className="text-xs">–í–µ—Å {usesWeight ? "(–∫–≥)" : "(–æ–ø—Ü.)"}</Label>
                                <Input
                                  className="rounded-xl"
                                  type="number"
                                  value={set.weight}
                                  onChange={(e) => {
                                    const v = e.target.value;
                                    setDraft((d) => ({
                                      ...d,
                                      [ex.id]: {
                                        sets: (d?.[ex.id]?.sets || []).map((x: any, j: number) => (j === si ? { ...x, weight: v } : x)),
                                      },
                                    }));
                                  }}
                                />
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="text-sm text-muted-foreground">–ù–µ—Ç —Å–µ—Å—Å–∏–π –≤ –ø–ª–∞–Ω–µ ‚Äî —É–≤–µ–ª–∏—á—å –¥–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.</div>
            )}

            <div className="flex flex-wrap gap-2">
              <Button className="rounded-xl" onClick={saveWorkout}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</Button>
              <Button
                className="rounded-xl"
                variant="secondary"
                onClick={() => {
                  if (!session) return;
                  const next: any = {};
                  for (const ex of session.exercises || []) {
                    const pr = parsePrescription(ex.prescription);
                    next[ex.id] = { sets: Array.from({ length: pr.sets }).map(() => ({ reps: "", weight: "" })) };
                  }
                  setDraft(next);
                }}
              >
                –û—á–∏—Å—Ç–∏—Ç—å
              </Button>
            </div>
          </CardContent>
        </Card>

        <Card className="rounded-2xl shadow-sm">
          <CardHeader>
            <CardTitle>–ò—Å—Ç–æ—Ä–∏—è</CardTitle>
          </CardHeader>
          <CardContent className="grid gap-3">
            <div className="text-sm text-muted-foreground">–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage) –∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –ø—Ä–æ—Ñ–∏–ª—é.</div>
            <div className="grid gap-2">
              {logs.slice(0, 12).map((l) => (
                <div key={l.id} className="rounded-2xl border p-3">
                  <div className="flex items-start justify-between gap-3">
                    <div>
                      <div className="text-sm font-medium">{l.dateISO}</div>
                      <div className="text-xs text-muted-foreground">{l.sessionTitle}</div>
                    </div>
                    <Button
                      variant="secondary"
                      className="rounded-xl"
                      onClick={() =>
                        setData((d: UserState) => ({
                          ...d,
                          workouts: { ...d.workouts, logs: (d.workouts?.logs || []).filter((x) => x.id !== l.id) },
                        }))
                      }
                    >
                      –£–¥–∞–ª–∏—Ç—å
                    </Button>
                  </div>
                  <div className="mt-2 text-xs text-muted-foreground">
                    {(l.entries || []).slice(0, 3).map((e) => {
                      const ex = resolveExercise(e.exerciseId);
                      const line = (e.sets || []).map((s) => `${s.weight ?? "‚Äî"}–∫–≥√ó${s.reps ?? "‚Äî"}`).join(" ¬∑ ");
                      return (
                        <div key={e.exerciseId}>
                          {(ex?.name || e.exerciseId)}: {line}
                        </div>
                      );
                    })}
                    {(l.entries || []).length > 3 ? <div>‚Ä¶</div> : null}
                  </div>
                </div>
              ))}
              {!logs.length ? <div className="text-sm text-muted-foreground">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –°–æ—Ö—Ä–∞–Ω–∏ –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É üôÇ</div> : null}
            </div>
          </CardContent>
        </Card>
      </div>

      <div className="text-xs text-muted-foreground">–ü—Ä–∞–≤–∏–ª–æ: –¥–æ–±–∏–ª –≤–µ—Ä—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –≤–æ –≤—Å–µ—Ö –ø–æ–¥—Ö–æ–¥–∞—Ö ‚Üí –ø—Ä–∏–±–∞–≤—å –≤–µ—Å. –ù–µ –¥–æ–±–∏–ª –Ω–∏–∑ ‚Üí –æ—Å—Ç–∞–≤—å/—á—É—Ç—å —Å–Ω–∏–∑—å.</div>
    </div>
  );
}

function WeeklyMuscleReport({ data }: { data: UserState }) {
  const startISO = data.nutrition.weekStartISO || weekStartMondayISO();
  const report = useMemo(() => computeWeeklyMuscleUsage(data.workouts.logs || [], startISO), [data.workouts.logs, startISO]);

  const totalScore = report.data.reduce((acc, x: any) => acc + (Number(x.score) || 0), 0);

  const chartData = report.data.map((x: any) => ({
    muscle: x.muscle,
    primarySets: x.primarySets,
    secondarySets: x.secondarySets,
    score: round(x.score, 1),
    share: totalScore ? Math.round((x.score / totalScore) * 100) : 0,
  }));

  return (
    <div className="grid gap-4 md:grid-cols-2">
      <Card className="rounded-2xl shadow-sm">
        <CardHeader>
          <CardTitle>–ù–∞–≥—Ä—É–∑–∫–∞ –ø–æ –º—ã—à—Ü–∞–º –∑–∞ –Ω–µ–¥–µ–ª—é</CardTitle>
        </CardHeader>
        <CardContent className="grid gap-3">
          <div className="rounded-2xl border bg-muted/30 p-3 text-sm">
            –ù–µ–¥–µ–ª—è: <span className="font-medium">{report.startISO}</span> ‚Üí <span className="font-medium">{report.endISO}</span>
            <div className="text-xs text-muted-foreground mt-1">
              –ì–ª–∞–≤–Ω—ã–µ/–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º—ã—à—Ü—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ –∫–∞–∂–¥–æ–º—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é –∏–∑ –ª–æ–≥–∞. –î–ª—è –¥–æ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Å: –≥–ª–∞–≤–Ω–∞—è√ó1.0, –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è√ó0.5.
            </div>
          </div>

          <div className="h-72">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={chartData} margin={{ top: 10, right: 20, bottom: 0, left: 0 }}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="muscle" tick={{ fontSize: 12 }} interval={0} />
                <YAxis tick={{ fontSize: 12 }} />
                <Tooltip />
                <Legend />
                <Bar dataKey="primarySets" name="–ì–ª–∞–≤–Ω–∞—è (–ø–æ–¥—Ö–æ–¥—ã)" stackId="a" />
                <Bar dataKey="secondarySets" name="–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è (–ø–æ–¥—Ö–æ–¥—ã)" stackId="a" />
              </BarChart>
            </ResponsiveContainer>
          </div>

          {!chartData.length ? <div className="text-sm text-muted-foreground">–ó–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é –Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –ª–æ–≥–æ–≤.</div> : null}
        </CardContent>
      </Card>

      <Card className="rounded-2xl shadow-sm">
        <CardHeader>
          <CardTitle>–°–≤–æ–¥–∫–∞</CardTitle>
        </CardHeader>
        <CardContent className="grid gap-3">
          <div className="text-sm text-muted-foreground">–ì–ª–∞–≤–Ω—ã–µ/–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∏ –¥–æ–ª—è (–ø–æ score).</div>
          <div className="rounded-2xl border p-3 grid gap-2">
            {chartData.map((x: any) => (
              <div key={x.muscle} className="flex items-center justify-between gap-3">
                <div className="text-sm font-medium">{x.muscle}</div>
                <div className="text-sm text-muted-foreground">
                  {x.primarySets} –≥–ª–∞–≤–Ω ¬∑ {x.secondarySets} –≤—Å–ø–æ–º ¬∑ {x.share}%
                </div>
              </div>
            ))}
            {!chartData.length ? <div className="text-sm text-muted-foreground">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div> : null}
          </div>

          <div className="rounded-2xl border bg-muted/30 p-3 text-xs text-muted-foreground">
            –ß—Ç–æ–±—ã –æ—Ç—á—ë—Ç —Ä–∞–±–æ—Ç–∞–ª ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ ¬´–¢—Ä–µ–∫–µ—Ä–µ¬ª. –ú–µ—Ç—Ä–∏–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç —É–≤–∏–¥–µ—Ç—å –ø–µ—Ä–µ–∫–æ—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–∞–ª–æ –Ω–æ–≥/—Å–ø–∏–Ω—ã).
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

// -----------------------------
// Nutrition helpers: actual meals
// -----------------------------

function ensureActualMealEntry(
  actual: UserState["nutrition"]["actual"],
  dateISO: string,
  slot: string,
  planned: { name: string; kcal: number; p: number; f: number; c: number }
) {
  const day = actual[dateISO] || { meals: {} as Record<string, NutritionActualMeal> };
  const meal = day.meals[slot];
  if (meal) return { ...actual, [dateISO]: day };
  return {
    ...actual,
    [dateISO]: {
      meals: {
        ...day.meals,
        [slot]: {
          eaten: true,
          name: planned.name,
          kcal: planned.kcal,
          p: planned.p,
          f: planned.f,
          c: planned.c,
          foods: [],
        },
      },
    },
  };
}

function computeActualTotals(plannedDay: PlannedDay, actualDay: { meals: Record<string, NutritionActualMeal> } | undefined) {
  if (!actualDay || !Object.keys(actualDay.meals || {}).length) return plannedDay.totals;

  const sum = { kcal: 0, p: 0, f: 0, c: 0 };

  for (const m of plannedDay.meals) {
    const a = actualDay.meals[m.slot];
    if (!a) {
      sum.kcal += m.kcal || 0;
      sum.p += m.p || 0;
      sum.f += m.f || 0;
      sum.c += m.c || 0;
      continue;
    }
    if (!a.eaten) continue;
    sum.kcal += Number(a.kcal) || 0;
    sum.p += Number(a.p) || 0;
    sum.f += Number(a.f) || 0;
    sum.c += Number(a.c) || 0;
  }

  return { kcal: Math.round(sum.kcal), p: Math.round(sum.p), f: Math.round(sum.f), c: Math.round(sum.c) };
}

// -----------------------------
// Food composer UI
// -----------------------------

function FoodComposer({
  foods,
  onChange,
  onApply,
}: {
  foods: MealFoodEntry[];
  onChange: (next: MealFoodEntry[]) => void;
  onApply: () => void;
}) {
  const [q, setQ] = useState("");
  const [selectedId, setSelectedId] = useState(FOOD_DB[0]?.id || "");
  const [grams, setGrams] = useState("100");

  const filtered = useMemo(() => {
    const s = q.trim().toLowerCase();
    if (!s) return FOOD_DB;
    return FOOD_DB.filter((f) => f.name.toLowerCase().includes(s));
  }, [q]);

  const preview = useMemo(() => computeMealFromFoods(foods || []), [foods]);

  return (
    <div className="grid gap-3">
      <div className="rounded-2xl border bg-muted/20 p-3">
        <div className="text-sm font-medium">–°–æ–±—Ä–∞—Ç—å –∏–∑ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</div>
        <div className="text-xs text-muted-foreground mt-1">–í—ã–±–µ—Ä–∏ –ø—Ä–æ–¥—É–∫—Ç, –∑–∞–¥–∞–π –≥—Ä–∞–º–º—ã, –¥–æ–±–∞–≤—å. –ó–∞—Ç–µ–º ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å¬ª.</div>

        <div className="mt-3 grid gap-3 sm:grid-cols-3">
          <Field label="–ü–æ–∏—Å–∫" hint="–ø–æ –±–∞–∑–µ">
            <Input className="rounded-xl" value={q} onChange={(e) => setQ(e.target.value)} placeholder="–∫—É—Ä–∏—Ü–∞, —Ä–∏—Å, —Ç–≤–æ—Ä–æ–≥‚Ä¶" />
          </Field>

          <Field label="–ü—Ä–æ–¥—É–∫—Ç">
            <Select value={selectedId} onValueChange={setSelectedId}>
              <SelectTrigger className="rounded-xl"><SelectValue placeholder="–í—ã–±–µ—Ä–∏" /></SelectTrigger>
              <SelectContent>
                {filtered.slice(0, 30).map((f) => (
                  <SelectItem key={f.id} value={f.id}>{f.name}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </Field>

          <Field label="–ì—Ä–∞–º–º—ã">
            <Input className="rounded-xl" type="number" value={grams} onChange={(e) => setGrams(e.target.value)} />
          </Field>
        </div>

        <div className="mt-3 flex flex-wrap gap-2">
          <Button
            className="rounded-xl"
            variant="secondary"
            onClick={() => {
              const g = Number(grams);
              if (!selectedId || !g || g <= 0) return;
              onChange([...(foods || []), { foodId: selectedId, grams: g }]);
            }}
          >
            + –î–æ–±–∞–≤–∏—Ç—å
          </Button>

          <Button
            className="rounded-xl"
            variant="secondary"
            onClick={() => onChange([])}
          >
            –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã
          </Button>

          <Button className="rounded-xl" onClick={onApply}>
            –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –ø—Ä–∏—ë–º—É
          </Button>
        </div>

        <div className="mt-3 rounded-2xl border p-3 grid gap-2">
          <div className="text-sm font-medium">–°–æ—Å—Ç–∞–≤</div>
          {(foods || []).map((e, i) => {
            const f = foodById(e.foodId);
            const m = f ? macrosFromFood(f, e.grams) : null;
            return (
              <div key={`${e.foodId}_${i}`} className="flex items-center justify-between gap-3">
                <div className="text-sm">{f?.name || e.foodId} ¬∑ {Math.round(e.grams)}–≥</div>
                <div className="flex items-center gap-2">
                  <div className="text-xs text-muted-foreground">{m ? `${m.kcal}–∫–∫–∞–ª ${m.p}P/${m.f}F/${m.c}C` : "‚Äî"}</div>
                  <Button
                    className="rounded-xl"
                    size="sm"
                    variant="secondary"
                    onClick={() => onChange((foods || []).filter((_, j) => j !== i))}
                  >
                    –£–¥–∞–ª–∏—Ç—å
                  </Button>
                </div>
              </div>
            );
          })}
          {!(foods || []).length ? <div className="text-sm text-muted-foreground">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div> : null}
        </div>

        <div className="mt-3 flex flex-wrap gap-2">
          <Badge variant="secondary">–ò—Ç–æ–≥–æ: {preview.kcal} –∫–∫–∞–ª</Badge>
          <Badge variant="outline">{preview.p}P</Badge>
          <Badge variant="outline">{preview.f}F</Badge>
          <Badge variant="outline">{preview.c}C</Badge>
        </div>
      </div>
    </div>
  );
}

// -----------------------------
// App
// -----------------------------

export default function App() {
  const [app, setApp] = useLocalStorageState<AppState>(STORAGE_KEY, {
    activeUserId: "u1",
    users: [
      {
        id: "u1",
        name: "–ü—Ä–æ—Ñ–∏–ª—å 1",
        state: makeDefaultUserState(),
      },
    ],
  });

  const activeUser = useMemo(() => {
    const found = app.users.find((u) => u.id === app.activeUserId);
    return found || app.users[0];
  }, [app.activeUserId, app.users]);

  const data = activeUser?.state as UserState;

  const setData = (updater: any) => {
    setApp((prev) => {
      const users = prev.users.map((u) => {
        if (u.id !== prev.activeUserId) return u;
        const nextState = typeof updater === "function" ? updater(u.state) : updater;
        return { ...u, state: nextState };
      });
      return { ...prev, users };
    });
  };

  // --- user management ---
  const addUser = () => {
    const name = prompt("–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–µ–∫—Å)")?.trim();
    if (!name) return;
    const id = makeId();
    setApp((prev) => ({
      ...prev,
      activeUserId: id,
      users: [...prev.users, { id, name, state: makeDefaultUserState() }],
    }));
  };

  const deleteUser = () => {
    if (app.users.length <= 1) return;
    const ok = confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å ¬´${activeUser.name}¬ª?`);
    if (!ok) return;
    setApp((prev) => {
      const remaining = prev.users.filter((u) => u.id !== prev.activeUserId);
      const nextActive = remaining[0]?.id || "";
      return { ...prev, activeUserId: nextActive, users: remaining };
    });
  };

  const renameUser = () => {
    const name = prompt("–ù–æ–≤–æ–µ –∏–º—è –ø—Ä–æ—Ñ–∏–ª—è", activeUser.name)?.trim();
    if (!name) return;
    setApp((prev) => ({
      ...prev,
      users: prev.users.map((u) => (u.id === prev.activeUserId ? { ...u, name } : u)),
    }));
  };

  // --- derived numbers ---

  const bmr = useMemo(() => calcBMR(data.profile as any), [data.profile]);
  const tdee = useMemo(() => (bmr ? bmr * activityFactor(data.profile.activity) : 0), [bmr, data.profile.activity]);

  const deficitKcalPerDay = useMemo(() => {
    const rate = paceToKgPerWeek(data.goal.pace);
    const daily = (rate * 7700) / 7;
    return clamp(daily, 250, 1000);
  }, [data.goal.pace]);

  const caloriesTarget = useMemo(() => {
    if (!tdee) return 2000;
    const target = data.goal.focus === "fat_loss" ? tdee - deficitKcalPerDay : tdee + 150;
    const floor = data.profile.sex === "female" ? 1300 : 1500;
    return Math.round(clamp(target, floor, 3500));
  }, [tdee, deficitKcalPerDay, data.goal.focus, data.profile.sex]);

  const macros = useMemo(
    () => macroTargets({ weightKg: data.profile.weightKg, caloriesTarget, focus: data.goal.focus }),
    [data.profile.weightKg, caloriesTarget, data.goal.focus]
  );

  const forecast = useMemo(
    () =>
      estimateWeeklyForecast({
        currentWeightKg: data.profile.weightKg,
        loseKg: data.goal.loseKg,
        pace: data.goal.pace,
      }),
    [data.profile.weightKg, data.goal.loseKg, data.goal.pace]
  );

  const weekStartISO = data.nutrition.weekStartISO || weekStartMondayISO();

  const menu = useMemo(
    () => generateWeeklyMenu({ caloriesTarget, seed: Number(data.nutrition.seed) || 1, weekStartISO }),
    [caloriesTarget, data.nutrition.seed, weekStartISO]
  );

  const shoppingList = useMemo(() => buildShoppingList(menu), [menu]);

  const availableEquipment = useMemo(() => {
    const eq = new Set<string>();
    for (const [k, v] of Object.entries(data.training.homeEquipment || {})) {
      if (v) eq.add(k);
    }
    return Array.from(eq);
  }, [data.training.homeEquipment]);

  const workoutPlan = useMemo(() => {
    return buildWorkoutPlan({
      daysPerWeek: data.training.daysPerWeek,
      location: data.training.location,
      availableEquipment,
      focus: data.goal.focus,
      cardioDays: data.training.cardioDays,
    });
  }, [data.training.daysPerWeek, data.training.location, availableEquipment, data.goal.focus, data.training.cardioDays]);

  const progressSeries = useMemo(() => {
    const logs = (data.progress.logs || []).slice().sort((a: any, b: any) => String(a.dateISO).localeCompare(String(b.dateISO)));
    return logs.map((l: any) => ({
      date: l.dateISO,
      weight: Number(l.weightKg) || null,
      waist: Number(l.waistCm) || null,
      chest: Number(l.chestCm) || null,
      hip: Number(l.hipCm) || null,
    }));
  }, [data.progress.logs]);

  const lastLog = useMemo(() => {
    const logs = data.progress.logs || [];
    if (!logs.length) return null;
    return logs.slice().sort((a: any, b: any) => String(b.dateISO).localeCompare(String(a.dateISO)))[0];
  }, [data.progress.logs]);

  const [newLog, setNewLog] = useState(() => {
    const iso = toISODateLocal(new Date());
    return { dateISO: iso, weightKg: "", waistCm: "", chestCm: "", hipCm: "" };
  });

  const addLog = () => {
    if (!newLog.dateISO) return;
    const entry = {
      dateISO: newLog.dateISO,
      weightKg: newLog.weightKg === "" ? null : Number(newLog.weightKg),
      waistCm: newLog.waistCm === "" ? null : Number(newLog.waistCm),
      chestCm: newLog.chestCm === "" ? null : Number(newLog.chestCm),
      hipCm: newLog.hipCm === "" ? null : Number(newLog.hipCm),
    };

    setData((d: UserState) => {
      const logs = (d.progress.logs || []).filter((x: any) => x.dateISO !== entry.dateISO);
      logs.push(entry);
      return { ...d, progress: { ...d.progress, logs } };
    });
  };

  const resetAll = () => {
    const ok = confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏ –∏ –¥–∞–Ω–Ω—ã–µ?");
    if (!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  };

  const headerStats = useMemo(() => {
    const weeks = forecast.length ? forecast.length - 1 : 0;
    const estEnd = forecast.length ? forecast[forecast.length - 1].weight : null;
    return {
      bmr: bmr ? `${Math.round(bmr)} –∫–∫–∞–ª` : "‚Äî",
      tdee: tdee ? `${Math.round(tdee)} –∫–∫–∞–ª` : "‚Äî",
      target: `${caloriesTarget} –∫–∫–∞–ª`,
      macros: macros.p ? `${macros.p}P / ${macros.f}F / ${macros.c}C` : "‚Äî",
      weeks: weeks ? `${weeks} –Ω–µ–¥` : "‚Äî",
      end: estEnd ? `${estEnd} –∫–≥` : "‚Äî",
    };
  }, [bmr, tdee, caloriesTarget, forecast, macros]);

  const regenMenu = () => {
    setData((d: UserState) => ({ ...d, nutrition: { ...d.nutrition, seed: (Number(d.nutrition.seed) || 1) + 1 } }));
  };

  const setWeekStart = (iso: string) => {
    setData((d: UserState) => ({ ...d, nutrition: { ...d.nutrition, weekStartISO: iso } }));
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-background to-muted/30">
      <div className="mx-auto max-w-6xl p-4 md:p-8 grid gap-6">
        <div className="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
          <div>
            <div className="text-2xl md:text-3xl font-semibold tracking-tight">–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</div>
            <div className="text-sm text-muted-foreground mt-1">–ú–µ–Ω—é (–ø–ª–∞–Ω+—Ñ–∞–∫—Ç) ¬∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ¬∑ –∞–Ω–∞–ª–∏–∑ –Ω–µ–¥–µ–ª–∏ ¬∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ñ–∏–ª–µ–π.</div>
          </div>

          <div className="flex flex-col sm:flex-row gap-2 items-start sm:items-center">
            <div className="flex gap-2 items-center flex-wrap">
              <Select value={app.activeUserId} onValueChange={(v) => setApp((p) => ({ ...p, activeUserId: v }))}>
                <SelectTrigger className="rounded-xl w-44"><SelectValue placeholder="–ü—Ä–æ—Ñ–∏–ª—å" /></SelectTrigger>
                <SelectContent>
                  {app.users.map((u) => (
                    <SelectItem key={u.id} value={u.id}>{u.name}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <Button variant="secondary" className="rounded-xl" onClick={addUser}>+ –ü—Ä–æ—Ñ–∏–ª—å</Button>
              <Button variant="secondary" className="rounded-xl" onClick={renameUser}>–ü–µ—Ä–µ–∏–º–µ–Ω.</Button>
              <Button variant="secondary" className="rounded-xl" onClick={deleteUser} disabled={app.users.length <= 1}>–£–¥–∞–ª–∏—Ç—å</Button>
            </div>

            <Button variant="secondary" className="rounded-xl" onClick={resetAll}>–°–±—Ä–æ—Å –≤—Å—ë</Button>
          </div>
        </div>

        <div className="grid gap-3 md:grid-cols-6">
          <StatPill title="BMR" value={headerStats.bmr} sub="–±–∞–∑–æ–≤—ã–π –æ–±–º–µ–Ω" />
          <StatPill title="TDEE" value={headerStats.tdee} sub="–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ" />
          <StatPill title="–¶–µ–ª—å –∫–∞–ª–æ—Ä–∏–π" value={headerStats.target} sub={data.goal.focus === "fat_loss" ? "–¥–µ—Ñ–∏—Ü–∏—Ç" : "–Ω–∞–±–æ—Ä/—Å–∏–ª–∞"} />
          <StatPill title="–¶–µ–ª—å –ë–ñ–£" value={headerStats.macros} sub="–≥/–¥–µ–Ω—å" />
          <StatPill title="–ü—Ä–æ–≥–Ω–æ–∑" value={headerStats.weeks} sub="–¥–æ —Ü–µ–ª–∏" />
          <StatPill title="–û–∂–∏–¥–∞–µ–º—ã–π –≤–µ—Å" value={headerStats.end} sub="–ø–æ –ø—Ä–æ–≥–Ω–æ–∑—É" />
        </div>

        <Tabs defaultValue="profile" className="w-full">
          <TabsList className="w-full flex flex-wrap justify-start">
            <TabsTrigger value="profile">–ü—Ä–æ—Ñ–∏–ª—å & —Ü–µ–ª—å</TabsTrigger>
            <TabsTrigger value="nutrition">–ú–µ–Ω—é</TabsTrigger>
            <TabsTrigger value="workouts">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</TabsTrigger>
            <TabsTrigger value="progress">–ü—Ä–æ–≥—Ä–µ—Å—Å</TabsTrigger>
            <TabsTrigger value="exercises">–ë–∞–∑–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</TabsTrigger>
          </TabsList>

          {/* PROFILE */}
          <TabsContent value="profile" className="mt-4">
            <div className="grid gap-4 md:grid-cols-2">
              <Card className="rounded-2xl shadow-sm">
                <CardHeader><CardTitle>–ü—Ä–æ—Ñ–∏–ª—å</CardTitle></CardHeader>
                <CardContent className="grid gap-4">
                  <div className="rounded-2xl border bg-muted/30 p-3 text-sm">
                    <div className="font-medium">–ú–∏–Ω–∏-–æ–Ω–±–æ—Ä–¥–∏–Ω–≥</div>
                    <div className="text-xs text-muted-foreground mt-1">1) –≤–æ–∑—Ä–∞—Å—Ç/—Ä–æ—Å—Ç/–≤–µ—Å ‚Üí 2) –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Üí 3) —Ü–µ–ª—å.</div>
                  </div>

                  <div className="grid gap-4 sm:grid-cols-2">
                    <Field label="–ü–æ–ª">
                      <Select value={data.profile.sex} onValueChange={(v) => setData((d: UserState) => ({ ...d, profile: { ...d.profile, sex: v } }))}>
                        <SelectTrigger className="rounded-xl"><SelectValue placeholder="–í—ã–±–µ—Ä–∏" /></SelectTrigger>
                        <SelectContent>
                          <SelectItem value="male">–ú—É–∂—Å–∫–æ–π</SelectItem>
                          <SelectItem value="female">–ñ–µ–Ω—Å–∫–∏–π</SelectItem>
                        </SelectContent>
                      </Select>
                    </Field>

                    <Field label="–í–æ–∑—Ä–∞—Å—Ç">
                      <Input className="rounded-xl" type="number" value={data.profile.age} onChange={(e) => setData((d: UserState) => ({ ...d, profile: { ...d.profile, age: Number(e.target.value) } }))} />
                    </Field>

                    <Field label="–†–æ—Å—Ç (—Å–º)">
                      <Input className="rounded-xl" type="number" value={data.profile.heightCm} onChange={(e) => setData((d: UserState) => ({ ...d, profile: { ...d.profile, heightCm: Number(e.target.value) } }))} />
                    </Field>

                    <Field label="–í–µ—Å (–∫–≥)">
                      <Input className="rounded-xl" type="number" value={data.profile.weightKg} onChange={(e) => setData((d: UserState) => ({ ...d, profile: { ...d.profile, weightKg: Number(e.target.value) } }))} />
                    </Field>
                  </div>

                  <Field label="–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å" hint="–≤–Ω–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (—Ä–∞–±–æ—Ç–∞/—à–∞–≥–∏)">
                    <Select value={data.profile.activity} onValueChange={(v) => setData((d: UserState) => ({ ...d, profile: { ...d.profile, activity: v } }))}>
                      <SelectTrigger className="rounded-xl"><SelectValue placeholder="–í—ã–±–µ—Ä–∏" /></SelectTrigger>
                      <SelectContent>
                        <SelectItem value="sedentary">–°–∏–¥—è—á–∞—è</SelectItem>
                        <SelectItem value="light">–õ—ë–≥–∫–∞—è</SelectItem>
                        <SelectItem value="moderate">–°—Ä–µ–¥–Ω—è—è</SelectItem>
                        <SelectItem value="high">–í—ã—Å–æ–∫–∞—è</SelectItem>
                        <SelectItem value="athlete">–°–ø–æ—Ä—Ç—Å–º–µ–Ω/–æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è</SelectItem>
                      </SelectContent>
                    </Select>
                  </Field>

                  <div className="rounded-2xl border bg-muted/30 p-3 text-sm">
                    <div className="flex flex-wrap gap-2 items-center">
                      <Badge variant="secondary">BMR ‚âà {headerStats.bmr}</Badge>
                      <Badge variant="secondary">TDEE ‚âà {headerStats.tdee}</Badge>
                      <Badge variant="secondary">–¶–µ–ª—å ‚âà {headerStats.target}</Badge>
                      <Badge variant="secondary">–ë–ñ–£ ‚âà {headerStats.macros}</Badge>
                    </div>
                    <div className="text-xs text-muted-foreground mt-2">–ï—Å–ª–∏ –≤–µ—Å —Å—Ç–æ–∏—Ç 2+ –Ω–µ–¥–µ–ª–∏ ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –∫–∞–ª–æ—Ä–∏–∏ –∏–ª–∏ —à–∞–≥–∏.</div>
                  </div>
                </CardContent>
              </Card>

              <Card className="rounded-2xl shadow-sm">
                <CardHeader><CardTitle>–¶–µ–ª—å</CardTitle></CardHeader>
                <CardContent className="grid gap-4">
                  <div className="grid gap-4 sm:grid-cols-2">
                    <Field label="–•–æ—á—É –ø–æ—Ö—É–¥–µ—Ç—å –Ω–∞ (–∫–≥)">
                      <Input className="rounded-xl" type="number" value={data.goal.loseKg} onChange={(e) => setData((d: UserState) => ({ ...d, goal: { ...d.goal, loseKg: Number(e.target.value) } }))} />
                    </Field>
                    <Field label="–¢–µ–º–ø">
                      <Select value={data.goal.pace} onValueChange={(v) => setData((d: UserState) => ({ ...d, goal: { ...d.goal, pace: v } }))}>
                        <SelectTrigger className="rounded-xl"><SelectValue placeholder="–í—ã–±–µ—Ä–∏" /></SelectTrigger>
                        <SelectContent>
                          <SelectItem value="conservative">–°–ø–æ–∫–æ–π–Ω–æ (‚âà0.35 –∫–≥/–Ω–µ–¥)</SelectItem>
                          <SelectItem value="normal">–ù–æ—Ä–º (‚âà0.6 –∫–≥/–Ω–µ–¥)</SelectItem>
                          <SelectItem value="aggressive">–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ (‚âà0.9 –∫–≥/–Ω–µ–¥)</SelectItem>
                        </SelectContent>
                      </Select>
                    </Field>
                  </div>

                  <Field label="–§–æ–∫—É—Å">
                    <div className="flex flex-wrap gap-2">
                      <Button variant={data.goal.focus === "fat_loss" ? "default" : "secondary"} className="rounded-xl" onClick={() => setData((d: UserState) => ({ ...d, goal: { ...d.goal, focus: "fat_loss" } }))}>–ü–æ—Ö—É–¥–µ–Ω–∏–µ</Button>
                      <Button variant={data.goal.focus === "strength" ? "default" : "secondary"} className="rounded-xl" onClick={() => setData((d: UserState) => ({ ...d, goal: { ...d.goal, focus: "strength" } }))}>–°–∏–ª–∞/—Ñ–æ—Ä–º–∞</Button>
                    </div>
                  </Field>

                  <Separator />

                  <div className="grid gap-2">
                    <div className="text-sm font-medium">–ü—Ä–æ–≥–Ω–æ–∑ –≤–µ—Å–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º</div>
                    {forecast?.length ? (
                      <div className="h-64 w-full">
                        <ResponsiveContainer width="100%" height="100%">
                          <LineChart data={forecast} margin={{ top: 10, right: 20, bottom: 0, left: 0 }}>
                            <CartesianGrid strokeDasharray="3 3" />
                            <XAxis dataKey="week" tick={{ fontSize: 12 }} interval="preserveStartEnd" />
                            <YAxis domain={["dataMin - 1", "dataMax + 1"]} tick={{ fontSize: 12 }} />
                            <Tooltip />
                            <Line type="monotone" dataKey="weight" dot={false} />
                          </LineChart>
                        </ResponsiveContainer>
                      </div>
                    ) : (
                      <div className="text-sm text-muted-foreground">–í–≤–µ–¥–∏ –≤–µ—Å –∏ —Ü–µ–ª—å (–∫–≥), —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥–Ω–æ–∑.</div>
                    )}
                    <div className="text-xs text-muted-foreground">–≠—Ç–æ –æ—Ü–µ–Ω–∫–∞. –†–µ–∞–ª—å–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç ¬´–≤–æ–ª–Ω–∞–º–∏¬ª –∏–∑ –≤–æ–¥—ã/—Å–Ω–∞/—Å—Ç—Ä–µ—Å—Å–∞.</div>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* NUTRITION */}
          <TabsContent value="nutrition" className="mt-4">
            <div className="grid gap-4 md:grid-cols-2">
              <Card className="rounded-2xl shadow-sm">
                <CardHeader><CardTitle>–ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é (–ø–ª–∞–Ω + —Ñ–∞–∫—Ç)</CardTitle></CardHeader>
                <CardContent className="grid gap-4">
                  <div className="rounded-2xl border bg-muted/30 p-3 text-sm">
                    <div className="flex flex-wrap items-center justify-between gap-3">
                      <div>
                        –¶–µ–ª—å: <span className="font-semibold">{caloriesTarget} –∫–∫–∞–ª/–¥–µ–Ω—å</span>
                        <div className="text-xs text-muted-foreground mt-1">–ë–ñ–£ —Ü–µ–ª—å: {macros.p}P / {macros.f}F / {macros.c}C</div>
                      </div>
                      <div className="flex gap-2">
                        <Button className="rounded-xl" variant="secondary" onClick={regenMenu}>–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</Button>
                      </div>
                    </div>

                    <div className="mt-3 grid gap-3 sm:grid-cols-2">
                      <Field label="–ù–µ–¥–µ–ª—è (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)">
                        <Input className="rounded-xl" type="date" value={weekStartISO} onChange={(e) => setWeekStart(e.target.value)} />
                      </Field>
                      <div className="rounded-2xl border p-3">
                        <div className="text-sm font-medium">–§–∞–∫—Ç –ø–æ –µ–¥–µ</div>
                        <div className="text-xs text-muted-foreground">–ö–Ω–æ–ø–∫–∞ ¬´–§–∞–∫—Ç¬ª ‚Üí –º–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –ø—Ä–∏—ë–º –∏–∑ –±–∞–∑—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤.</div>
                      </div>
                    </div>
                  </div>

                  <NutritionWeek menu={menu} caloriesTarget={caloriesTarget} data={data} setData={setData} />
                </CardContent>
              </Card>

              <Card className="rounded-2xl shadow-sm">
                <CardHeader><CardTitle>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –Ω–∞ –Ω–µ–¥–µ–ª—é</CardTitle></CardHeader>
                <CardContent className="grid gap-3">
                  <div className="text-sm text-muted-foreground">–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ —Å—Ç—Ä–æ–∏—Ç—Å—è –∏–∑ –ø–ª–∞–Ω–æ–≤–æ–≥–æ –º–µ–Ω—é (–Ω–µ –∏–∑ —Ñ–∞–∫—Ç–∞).</div>
                  <div className="rounded-2xl border p-3">
                    <div className="grid gap-2">
                      {shoppingList.map((it) => (
                        <div key={it.name + it.unit} className="flex items-center justify-between gap-3">
                          <div className="text-sm">{it.name}</div>
                          <div className="text-sm text-muted-foreground">{formatShoppingQty(it.qty, it.unit)}</div>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="grid gap-2 sm:grid-cols-2">
                    <Button
                      className="rounded-xl"
                      onClick={() => {
                        const text = shoppingList.map((it) => `- ${it.name}: ${formatShoppingQty(it.qty, it.unit)}`).join(NL);
                        navigator.clipboard?.writeText(text);
                      }}
                    >
                      –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫
                    </Button>
                    <Button
                      className="rounded-xl"
                      variant="secondary"
                      onClick={() => {
                        const text = menu
                          .map((d) => {
                            const lines = d.meals
                              .map((m) => `  ‚Ä¢ ${m.slot}: ${m.name} (${m.kcal}–∫–∫–∞–ª, ${m.p}P/${m.f}F/${m.c}C)`)
                              .join(NL);
                            return `${d.day} (${d.dateISO}) ‚Äî ${d.totals.kcal}–∫–∫–∞–ª (${d.totals.p}P/${d.totals.f}F/${d.totals.c}C)` + NL + lines;
                          })
                          .join(NL2);
                        navigator.clipboard?.writeText(text);
                      }}
                    >
                      –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω—é
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* WORKOUTS */}
          <TabsContent value="workouts" className="mt-4">
            <Tabs defaultValue="plan" className="w-full">
              <TabsList className="w-full flex flex-wrap justify-start">
                <TabsTrigger value="plan">–ü–ª–∞–Ω</TabsTrigger>
                <TabsTrigger value="tracker">–¢—Ä–µ–∫–µ—Ä</TabsTrigger>
                <TabsTrigger value="week">–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏</TabsTrigger>
              </TabsList>

              <TabsContent value="plan" className="mt-4">
                <div className="grid gap-4 md:grid-cols-2">
                  <Card className="rounded-2xl shadow-sm">
                    <CardHeader><CardTitle>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</CardTitle></CardHeader>
                    <CardContent className="grid gap-4">
                      <div className="grid gap-4 sm:grid-cols-2">
                        <Field label="–ì–¥–µ —Ç—Ä–µ–Ω–∏—Ä—É—é—Å—å">
                          <Select value={data.training.location} onValueChange={(v) => setData((d: UserState) => ({ ...d, training: { ...d.training, location: v } }))}>
                            <SelectTrigger className="rounded-xl"><SelectValue placeholder="–í—ã–±–µ—Ä–∏" /></SelectTrigger>
                            <SelectContent>
                              <SelectItem value="gym">–í –∑–∞–ª–µ</SelectItem>
                              <SelectItem value="home">–î–æ–º–∞</SelectItem>
                            </SelectContent>
                          </Select>
                        </Field>
                        <Field label="–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –Ω–µ–¥–µ–ª—é">
                          <Input className="rounded-xl" type="number" value={data.training.daysPerWeek} onChange={(e) => setData((d: UserState) => ({ ...d, training: { ...d.training, daysPerWeek: Number(e.target.value) } }))} />
                        </Field>
                        <Field label="–ö–∞—Ä–¥–∏–æ –¥–Ω–µ–π/–Ω–µ–¥">
                          <Input className="rounded-xl" type="number" value={data.training.cardioDays} onChange={(e) => setData((d: UserState) => ({ ...d, training: { ...d.training, cardioDays: Number(e.target.value) } }))} />
                        </Field>
                      </div>

                      <Field label="–ó–∞–º–µ—Ç–∫–∏" hint="—Ç—Ä–∞–≤–º—ã/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è/–ø–æ–∂–µ–ª–∞–Ω–∏—è">
                        <Textarea className="rounded-xl" value={data.training.notes} onChange={(e) => setData((d: UserState) => ({ ...d, training: { ...d.training, notes: e.target.value } }))} placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–æ–ª–∏—Ç –ø–ª–µ—á–æ, –Ω–µ —Ö–æ—á—É –ø—Ä–∏—Å–µ–¥—ã‚Ä¶" />
                      </Field>

                      <Separator />

                      <div className="grid gap-2">
                        <div className="text-sm font-medium">–î–æ–º–∞—à–Ω–µ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</div>
                        <div className="text-xs text-muted-foreground">–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∑–∞–ª ‚Äî –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –≤—Å—ë –µ—Å—Ç—å.</div>
                        <div className="grid gap-2 sm:grid-cols-2">
                          {EQUIPMENT.filter((e) => e.id !== "none").map((eq) => {
                            const checked = Boolean(data.training.homeEquipment?.[eq.id]);
                            return (
                              <div key={eq.id} className="flex items-center gap-2 rounded-xl border p-2">
                                <Checkbox
                                  checked={checked}
                                  onCheckedChange={(v) =>
                                    setData((d: UserState) => ({
                                      ...d,
                                      training: { ...d.training, homeEquipment: { ...d.training.homeEquipment, [eq.id]: Boolean(v) } },
                                    }))
                                  }
                                />
                                <div className="text-sm">{eq.label}</div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  <Card className="rounded-2xl shadow-sm">
                    <CardHeader><CardTitle>–ü–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</CardTitle></CardHeader>
                    <CardContent className="grid gap-4">
                      <div className="rounded-2xl border bg-muted/30 p-3 text-sm">
                        <div className="font-medium">–ö–∞—Ä–¥–∏–æ</div>
                        <div className="text-sm text-muted-foreground mt-1">{workoutPlan.cardio.recommendation}</div>
                        <div className="text-xs text-muted-foreground mt-2">–°–æ–Ω –∏ —à–∞–≥–∏ ‚Äî —Ç–∞–π–Ω—ã–µ —á–∏—Ç-–∫–æ–¥—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.</div>
                      </div>

                      <div className="grid gap-3">
                        {workoutPlan.sessions.map((s: any, idx: number) => (
                          <div key={idx} className="rounded-2xl border p-3">
                            <div className="flex items-center justify-between gap-3">
                              <div className="font-medium">–î–µ–Ω—å {idx + 1}: {s.title}</div>
                              <Badge variant="secondary">{s.exercises.length} —É–ø—Ä–∞–∂–Ω.</Badge>
                            </div>
                            <div className="mt-3 grid gap-2">
                              {s.exercises.map((ex: any) => (
                                <div key={ex.id} className="flex flex-col gap-1 rounded-xl border p-2">
                                  <div className="flex items-start justify-between gap-3">
                                    <div className="flex items-start gap-3">
                                      <div className="rounded-xl overflow-hidden border bg-muted/20 shrink-0">
                                        <img
                                          src={getExerciseImage(data, ex)}
                                          alt={ex.name}
                                          className="h-14 w-20 object-cover"
                                        />
                                      </div>
                                      <div>
                                        <div className="text-sm font-medium">{ex.name}</div>
                                        <div className="text-xs text-muted-foreground">
                                          –ì–ª–∞–≤–Ω–∞—è: {ex.muscle}
                                          {ex.secondaryMuscles?.length ? ` ¬∑ –í—Å–ø–æ–º–æ–≥.: ${ex.secondaryMuscles.join(", ")}` : ""}
                                        </div>
                                      </div>
                                    </div>
                                    <div className="text-sm font-medium">{ex.prescription}</div>
                                  </div>
                                  <div className="flex items-center justify-between text-xs text-muted-foreground">
                                    <div>–û—Ç–¥—ã—Ö: {ex.rest}</div>
                                    <div className="flex gap-1 flex-wrap justify-end">
                                      {(ex.equip || []).map((e: string) => (
                                        <Badge key={e} variant="outline" className="rounded-xl">{EQUIPMENT.find((x) => x.id === e)?.label || e}</Badge>
                                      ))}
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>

                      <div className="text-xs text-muted-foreground">–ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è: –≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–µ–¥–µ–ª –ø–æ–≤—Ç–æ—Ä–æ–≤ –ª–µ–≥–∫–æ ‚Üí –¥–æ–±–∞–≤—å 1‚Äì2 –ø–æ–≤—Ç–æ—Ä–∞ –∏–ª–∏ +2‚Äì5% –≤–µ—Å–∞.</div>
                    </CardContent>
                  </Card>
                </div>
              </TabsContent>

              <TabsContent value="tracker" className="mt-4">
                <WorkoutTracker data={data} setData={setData} workoutPlan={workoutPlan} />
              </TabsContent>

              <TabsContent value="week" className="mt-4">
                <WeeklyMuscleReport data={data} />
              </TabsContent>
            </Tabs>
          </TabsContent>

          {/* PROGRESS */}
          <TabsContent value="progress" className="mt-4">
            <div className="grid gap-4 md:grid-cols-2">
              <Card className="rounded-2xl shadow-sm">
                <CardHeader><CardTitle>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ä—ã/–≤–µ—Å</CardTitle></CardHeader>
                <CardContent className="grid gap-4">
                  <div className="grid gap-4 sm:grid-cols-2">
                    <Field label="–î–∞—Ç–∞"><Input className="rounded-xl" type="date" value={newLog.dateISO} onChange={(e) => setNewLog((s) => ({ ...s, dateISO: e.target.value }))} /></Field>
                    <Field label="–í–µ—Å (–∫–≥)"><Input className="rounded-xl" type="number" value={newLog.weightKg} onChange={(e) => setNewLog((s) => ({ ...s, weightKg: e.target.value }))} /></Field>
                    <Field label="–¢–∞–ª–∏—è (—Å–º)"><Input className="rounded-xl" type="number" value={newLog.waistCm} onChange={(e) => setNewLog((s) => ({ ...s, waistCm: e.target.value }))} /></Field>
                    <Field label="–ì—Ä—É–¥—å (—Å–º)"><Input className="rounded-xl" type="number" value={newLog.chestCm} onChange={(e) => setNewLog((s) => ({ ...s, chestCm: e.target.value }))} /></Field>
                    <Field label="–ë—ë–¥—Ä–∞ (—Å–º)"><Input className="rounded-xl" type="number" value={newLog.hipCm} onChange={(e) => setNewLog((s) => ({ ...s, hipCm: e.target.value }))} /></Field>
                  </div>
                  <Button className="rounded-xl" onClick={addLog}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</Button>

                  <div className="rounded-2xl border bg-muted/30 p-3 text-sm">
                    <div className="font-medium">–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å</div>
                    {lastLog ? (
                      <div className="mt-2 grid gap-1 text-sm text-muted-foreground">
                        <div>–î–∞—Ç–∞: <span className="text-foreground font-medium">{lastLog.dateISO}</span></div>
                        <div>–í–µ—Å: <span className="text-foreground font-medium">{lastLog.weightKg ?? "‚Äî"} –∫–≥</span></div>
                        <div>–¢–∞–ª–∏—è: <span className="text-foreground font-medium">{lastLog.waistCm ?? "‚Äî"} —Å–º</span></div>
                      </div>
                    ) : (
                      <div className="text-muted-foreground mt-2">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>
                    )}
                  </div>
                </CardContent>
              </Card>

              <Card className="rounded-2xl shadow-sm">
                <CardHeader><CardTitle>–ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</CardTitle></CardHeader>
                <CardContent className="grid gap-4">
                  {progressSeries.length ? (
                    <div className="h-72">
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={progressSeries} margin={{ top: 10, right: 20, bottom: 0, left: 0 }}>
                          <CartesianGrid strokeDasharray="3 3" />
                          <XAxis dataKey="date" tick={{ fontSize: 12 }} interval="preserveStartEnd" />
                          <YAxis tick={{ fontSize: 12 }} />
                          <Tooltip />
                          <Line type="monotone" dataKey="weight" dot={false} />
                        </LineChart>
                      </ResponsiveContainer>
                    </div>
                  ) : (
                    <div className="text-sm text-muted-foreground">–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–ø–∏—Å—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≥—Ä–∞—Ñ–∏–∫.</div>
                  )}

                  <div className="rounded-2xl border p-3">
                    <div className="text-sm font-medium">–ñ—É—Ä–Ω–∞–ª</div>
                    <div className="mt-2 grid gap-2">
                      {(data.progress.logs || [])
                        .slice()
                        .sort((a: any, b: any) => String(b.dateISO).localeCompare(String(a.dateISO)))
                        .map((l: any) => (
                          <div key={l.dateISO} className="flex items-center justify-between gap-3 rounded-xl border p-2">
                            <div>
                              <div className="text-sm font-medium">{l.dateISO}</div>
                              <div className="text-xs text-muted-foreground">–í–µ—Å: {l.weightKg ?? "‚Äî"} –∫–≥ ¬∑ –¢–∞–ª–∏—è: {l.waistCm ?? "‚Äî"} —Å–º</div>
                            </div>
                            <Button
                              variant="secondary"
                              className="rounded-xl"
                              onClick={() =>
                                setData((d: UserState) => ({
                                  ...d,
                                  progress: { ...d.progress, logs: (d.progress.logs || []).filter((x: any) => x.dateISO !== l.dateISO) },
                                }))
                              }
                            >
                              –£–¥–∞–ª–∏—Ç—å
                            </Button>
                          </div>
                        ))}
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          {/* EXERCISES */}
          <TabsContent value="exercises" className="mt-4">
            <ExerciseDB data={data} setData={setData} availableEquipment={availableEquipment} />
          </TabsContent>
        </Tabs>

        <div className="text-xs text-muted-foreground">‚ö†Ô∏è –ù–µ –º–µ–¥. —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è. –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è/—Ç—Ä–∞–≤–º—ã ‚Äî —Å–æ–≥–ª–∞—Å—É–π –¥–µ—Ñ–∏—Ü–∏—Ç –∏ –Ω–∞–≥—Ä—É–∑–∫—É —Å –≤—Ä–∞—á–æ–º/—Ç—Ä–µ–Ω–µ—Ä–æ–º.</div>
      </div>
    </div>
  );
}

function NutritionWeek({
  menu,
  caloriesTarget,
  data,
  setData,
}: {
  menu: PlannedDay[];
  caloriesTarget: number;
  data: UserState;
  setData: any;
}) {
  const [open, setOpen] = useState<Record<string, boolean>>({});

  return (
    <div className="grid gap-3">
      {menu.map((d) => {
        const actualDay = data.nutrition.actual?.[d.dateISO];
        const totals = computeActualTotals(d, actualDay);
        const delta = Math.round((totals.kcal || 0) - caloriesTarget);

        return (
          <div key={d.day + d.dateISO} className="rounded-2xl border p-3">
            <div className="flex items-center justify-between gap-3">
              <div className="font-medium">{d.day} ¬∑ {d.dateISO}</div>
              <div className="flex items-center gap-2 flex-wrap justify-end">
                <Badge variant="secondary">{totals.kcal} –∫–∫–∞–ª</Badge>
                <Badge variant="outline">{totals.p}P</Badge>
                <Badge variant="outline">{totals.f}F</Badge>
                <Badge variant="outline">{totals.c}C</Badge>
                <Badge variant={Math.abs(delta) <= 150 ? "secondary" : "outline"} className="rounded-xl">
                  {delta >= 0 ? `+${delta}` : `${delta}`} –∫–∫–∞–ª
                </Badge>
              </div>
            </div>

            <div className="mt-3 grid gap-2">
              {d.meals.map((m) => {
                const key = `${d.dateISO}__${m.slot}`;
                const isOpen = Boolean(open[key]);
                const actual = data.nutrition.actual?.[d.dateISO]?.meals?.[m.slot];

                const shownName = actual ? actual.name : m.name;
                const shownKcal = actual ? (actual.eaten ? actual.kcal : 0) : m.kcal;
                const shownP = actual ? (actual.eaten ? actual.p : 0) : m.p;
                const shownF = actual ? (actual.eaten ? actual.f : 0) : m.f;
                const shownC = actual ? (actual.eaten ? actual.c : 0) : m.c;

                return (
                  <div key={m.slot + m.name} className="rounded-xl border p-2">
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <div className="text-sm font-medium">{m.slot}</div>
                        <div className="text-sm text-muted-foreground">{shownName}</div>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="text-sm font-medium">{shownKcal} –∫–∫–∞–ª</div>
                        <Button
                          variant="secondary"
                          className="rounded-xl"
                          onClick={() => {
                            setData((u: UserState) => ({
                              ...u,
                              nutrition: {
                                ...u.nutrition,
                                actual: ensureActualMealEntry(u.nutrition.actual || {}, d.dateISO, m.slot, {
                                  name: m.name,
                                  kcal: m.kcal,
                                  p: m.p,
                                  f: m.f,
                                  c: m.c,
                                }),
                              },
                            }));
                            setOpen((p) => ({ ...p, [key]: !p[key] }));
                          }}
                        >
                          {isOpen ? "–ó–∞–∫—Ä—ã—Ç—å" : "–§–∞–∫—Ç"}
                        </Button>
                      </div>
                    </div>

                    <div className="mt-2 flex flex-wrap gap-1 text-xs">
                      <Badge variant="secondary" className="rounded-xl">{shownP}P</Badge>
                      <Badge variant="secondary" className="rounded-xl">{shownF}F</Badge>
                      <Badge variant="secondary" className="rounded-xl">{shownC}C</Badge>
                      <Badge variant="outline" className="rounded-xl">–ø–ª–∞–Ω √ó{round(m.scale || 1, 2)}</Badge>
                      {actual && !actual.eaten ? <Badge variant="outline" className="rounded-xl">–Ω–µ –µ–ª</Badge> : null}
                    </div>

                    {isOpen ? (
                      <div className="mt-3 rounded-xl border bg-muted/20 p-3 grid gap-3">
                        <div className="flex items-center justify-between gap-3">
                          <div className="text-sm font-medium">–ß—Ç–æ —Å—ä–µ–ª –ø–æ —Ñ–∞–∫—Ç—É</div>
                          <div className="flex items-center gap-2">
                            <div className="text-xs text-muted-foreground">–°—ä–µ–ª</div>
                            <Checkbox
                              checked={Boolean(actual?.eaten)}
                              onCheckedChange={(v) =>
                                setData((u: UserState) => ({
                                  ...u,
                                  nutrition: {
                                    ...u.nutrition,
                                    actual: {
                                      ...(u.nutrition.actual || {}),
                                      [d.dateISO]: {
                                        meals: {
                                          ...(u.nutrition.actual?.[d.dateISO]?.meals || {}),
                                          [m.slot]: { ...(u.nutrition.actual?.[d.dateISO]?.meals?.[m.slot] as any), eaten: Boolean(v) },
                                        },
                                      },
                                    },
                                  },
                                }))
                              }
                            />
                          </div>
                        </div>

                        <FoodComposer
                          foods={(actual?.foods || []) as any}
                          onChange={(next) =>
                            setData((u: UserState) => ({
                              ...u,
                              nutrition: {
                                ...u.nutrition,
                                actual: {
                                  ...(u.nutrition.actual || {}),
                                  [d.dateISO]: {
                                    meals: {
                                      ...(u.nutrition.actual?.[d.dateISO]?.meals || {}),
                                      [m.slot]: { ...(u.nutrition.actual?.[d.dateISO]?.meals?.[m.slot] as any), foods: next },
                                    },
                                  },
                                },
                              },
                            }))
                          }
                          onApply={() => {
                            const computed = computeMealFromFoods(actual?.foods || []);
                            if (!computed.kcal && !(actual?.foods || []).length) return;
                            setData((u: UserState) => ({
                              ...u,
                              nutrition: {
                                ...u.nutrition,
                                actual: {
                                  ...(u.nutrition.actual || {}),
                                  [d.dateISO]: {
                                    meals: {
                                      ...(u.nutrition.actual?.[d.dateISO]?.meals || {}),
                                      [m.slot]: {
                                        ...(u.nutrition.actual?.[d.dateISO]?.meals?.[m.slot] as any),
                                        name: computed.name || (u.nutrition.actual?.[d.dateISO]?.meals?.[m.slot] as any)?.name,
                                        kcal: computed.kcal,
                                        p: computed.p,
                                        f: computed.f,
                                        c: computed.c,
                                      },
                                    },
                                  },
                                },
                              },
                            }));
                          }}
                        />

                        <Separator />

                        <div className="text-sm font-medium">–†—É—á–Ω–∞—è –ø—Ä–∞–≤–∫–∞ (–µ—Å–ª–∏ –Ω–∞–¥–æ)</div>
                        <Field label="–ù–∞–∑–≤–∞–Ω–∏–µ">
                          <Input
                            className="rounded-xl"
                            value={actual?.name ?? m.name}
                            onChange={(e) =>
                              setData((u: UserState) => ({
                                ...u,
                                nutrition: {
                                  ...u.nutrition,
                                  actual: {
                                    ...(u.nutrition.actual || {}),
                                    [d.dateISO]: {
                                      meals: {
                                        ...(u.nutrition.actual?.[d.dateISO]?.meals || {}),
                                        [m.slot]: { ...(u.nutrition.actual?.[d.dateISO]?.meals?.[m.slot] as any), name: e.target.value },
                                      },
                                    },
                                  },
                                },
                              }))
                            }
                          />
                        </Field>

                        <div className="grid gap-3 sm:grid-cols-4">
                          <Field label="–∫–∫–∞–ª">
                            <Input
                              className="rounded-xl"
                              type="number"
                              value={String(actual?.kcal ?? m.kcal)}
                              onChange={(e) => {
                                const v = Number(e.target.value);
                                setData((u: UserState) => ({
                                  ...u,
                                  nutrition: {
                                    ...u.nutrition,
                                    actual: {
                                      ...(u.nutrition.actual || {}),
                                      [d.dateISO]: {
                                        meals: {
                                          ...(u.nutrition.actual?.[d.dateISO]?.meals || {}),
                                          [m.slot]: { ...(u.nutrition.actual?.[d.dateISO]?.meals?.[m.slot] as any), kcal: v },
                                        },
                                      },
                                    },
                                  },
                                }));
                              }}
                            />
                          </Field>
                          <Field label="P (–≥)">
                            <Input
                              className="rounded-xl"
                              type="number"
                              value={String(actual?.p ?? m.p)}
                              onChange={(e) => {
                                const v = Number(e.target.value);
                                setData((u: UserState) => ({
                                  ...u,
                                  nutrition: {
                                    ...u.nutrition,
                                    actual: {
                                      ...(u.nutrition.actual || {}),
                                      [d.dateISO]: {
                                        meals: {
                                          ...(u.nutrition.actual?.[d.dateISO]?.meals || {}),
                                          [m.slot]: { ...(u.nutrition.actual?.[d.dateISO]?.meals?.[m.slot] as any), p: v },
                                        },
                                      },
                                    },
                                  },
                                }));
                              }}
                            />
                          </Field>
                          <Field label="F (–≥)">
                            <Input
                              className="rounded-xl"
                              type="number"
                              value={String(actual?.f ?? m.f)}
                              onChange={(e) => {
                                const v = Number(e.target.value);
                                setData((u: UserState) => ({
                                  ...u,
                                  nutrition: {
                                    ...u.nutrition,
                                    actual: {
                                      ...(u.nutrition.actual || {}),
                                      [d.dateISO]: {
                                        meals: {
                                          ...(u.nutrition.actual?.[d.dateISO]?.meals || {}),
                                          [m.slot]: { ...(u.nutrition.actual?.[d.dateISO]?.meals?.[m.slot] as any), f: v },
                                        },
                                      },
                                    },
                                  },
                                }));
                              }}
                            />
                          </Field>
                          <Field label="C (–≥)">
                            <Input
                              className="rounded-xl"
                              type="number"
                              value={String(actual?.c ?? m.c)}
                              onChange={(e) => {
                                const v = Number(e.target.value);
                                setData((u: UserState) => ({
                                  ...u,
                                  nutrition: {
                                    ...u.nutrition,
                                    actual: {
                                      ...(u.nutrition.actual || {}),
                                      [d.dateISO]: {
                                        meals: {
                                          ...(u.nutrition.actual?.[d.dateISO]?.meals || {}),
                                          [m.slot]: { ...(u.nutrition.actual?.[d.dateISO]?.meals?.[m.slot] as any), c: v },
                                        },
                                      },
                                    },
                                  },
                                }));
                              }}
                            />
                          </Field>
                        </div>

                        <div className="flex flex-wrap gap-2">
                          <Button
                            variant="secondary"
                            className="rounded-xl"
                            onClick={() => {
                              setData((u: UserState) => {
                                const day = u.nutrition.actual?.[d.dateISO];
                                if (!day?.meals?.[m.slot]) return u;
                                const { [m.slot]: _rm, ...restMeals } = day.meals;
                                const nextActual = { ...(u.nutrition.actual || {}) };
                                if (Object.keys(restMeals).length === 0) {
                                  delete nextActual[d.dateISO];
                                } else {
                                  nextActual[d.dateISO] = { meals: restMeals as any };
                                }
                                return { ...u, nutrition: { ...u.nutrition, actual: nextActual } };
                              });
                            }}
                          >
                            –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∞–∫—Ç (—ç—Ç–æ—Ç –ø—Ä–∏—ë–º)
                          </Button>
                        </div>
                      </div>
                    ) : null}
                  </div>
                );
              })}
            </div>

            <div className="mt-3 flex flex-wrap gap-2">
              <Button
                variant="secondary"
                className="rounded-xl"
                onClick={() =>
                  setData((u: UserState) => {
                    const next = { ...(u.nutrition.actual || {}) };
                    delete next[d.dateISO];
                    return { ...u, nutrition: { ...u.nutrition, actual: next } };
                  })
                }
              >
                –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∞–∫—Ç –∑–∞ –¥–µ–Ω—å
              </Button>
            </div>
          </div>
        );
      })}
    </div>
  );
}

function ExerciseDB({ data, setData, availableEquipment }: { data: UserState; setData: any; availableEquipment: string[] }) {
  const [query, setQuery] = useState("");
  const [muscle, setMuscle] = useState("all");
  const [onlyDoable, setOnlyDoable] = useState(true);

  const available = useMemo(() => {
    const s = new Set(availableEquipment);
    if (data.training.location === "gym") {
      ["cable", "machines", "bench", "barbell", "dumbbells"].forEach((x) => s.add(x));
    }
    return s;
  }, [availableEquipment, data.training.location]);

  const list = useMemo(() => {
    const q = query.trim().toLowerCase();
    return EXERCISES.filter((e) => {
      if (muscle !== "all" && e.muscle !== muscle) return false;
      if (q && !e.name.toLowerCase().includes(q)) return false;
      if (onlyDoable && !hasAllEquipment(e, available)) return false;
      return true;
    });
  }, [query, muscle, onlyDoable, available]);

  const missingList = useMemo(() => {
    const q = query.trim().toLowerCase();
    return EXERCISES.filter((e) => {
      if (muscle !== "all" && e.muscle !== muscle) return false;
      if (q && !e.name.toLowerCase().includes(q)) return false;
      if (hasAllEquipment(e, available)) return false;
      return true;
    });
  }, [query, muscle, available]);

  return (
    <div className="grid gap-4 md:grid-cols-2">
      <Card className="rounded-2xl shadow-sm">
        <CardHeader><CardTitle>–ë–∞–∑–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</CardTitle></CardHeader>
        <CardContent className="grid gap-4">
          <div className="grid gap-3">
            <Field label="–ü–æ–∏—Å–∫"><Input className="rounded-xl" value={query} onChange={(e) => setQuery(e.target.value)} placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ç—è–≥–∞, –∂–∏–º, –ø—Ä–∏—Å–µ–¥" /></Field>
            <div className="grid gap-3 sm:grid-cols-2">
              <Field label="–ì—Ä—É–ø–ø–∞">
                <Select value={muscle} onValueChange={setMuscle}>
                  <SelectTrigger className="rounded-xl"><SelectValue placeholder="–í—ã–±–µ—Ä–∏" /></SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">–í—Å–µ</SelectItem>
                    <SelectItem value="–ì—Ä—É–¥—å">–ì—Ä—É–¥—å</SelectItem>
                    <SelectItem value="–°–ø–∏–Ω–∞">–°–ø–∏–Ω–∞</SelectItem>
                    <SelectItem value="–ù–æ–≥–∏">–ù–æ–≥–∏</SelectItem>
                    <SelectItem value="–ü–ª–µ—á–∏">–ü–ª–µ—á–∏</SelectItem>
                    <SelectItem value="–†—É–∫–∏">–†—É–∫–∏</SelectItem>
                    <SelectItem value="–ö–æ—Ä">–ö–æ—Ä</SelectItem>
                  </SelectContent>
                </Select>
              </Field>
              <div className="rounded-2xl border p-3 flex items-center justify-between">
                <div>
                  <div className="text-sm font-medium">–¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ</div>
                  <div className="text-xs text-muted-foreground">–ø–æ —Ç–≤–æ–µ–º—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é</div>
                </div>
                <Switch checked={onlyDoable} onCheckedChange={setOnlyDoable} />
              </div>
            </div>
            <div className="rounded-2xl border bg-muted/30 p-3 text-xs text-muted-foreground">–ó–∞–ª = –ø–æ—á—Ç–∏ –≤—Å—ë –¥–æ—Å—Ç—É–ø–Ω–æ. –î–æ–º = —Ç–æ–ª—å–∫–æ –æ—Ç–º–µ—á–µ–Ω–Ω–æ–µ.</div>
          </div>

          <div className="grid gap-2">
            {list.map((e) => (
              <ExerciseRow key={e.id} ex={e} data={data} setData={setData} available={available} />
            ))}
            {!list.length ? <div className="text-sm text-muted-foreground">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div> : null}
          </div>
        </CardContent>
      </Card>

      <Card className="rounded-2xl shadow-sm">
        <CardHeader><CardTitle>–ó–∞–º–µ–Ω—ã (–Ω–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è ‚Üí –¥–µ–ª–∞–µ–º —ç—Ç–æ)</CardTitle></CardHeader>
        <CardContent className="grid gap-4">
          <div className="text-sm text-muted-foreground">–ü–æ–∫–∞–∑—ã–≤–∞—é –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–º–µ–Ω.</div>

          <div className="grid gap-3">
            {missingList.slice(0, 10).map((e) => {
              const suggestions = suggestSubstitutions({ exercise: e, available });
              return (
                <div key={e.id} className="rounded-2xl border p-3">
                  <div className="flex items-start justify-between gap-3">
                    <div>
                      <div className="text-sm font-medium">{e.name}</div>
                      <div className="text-xs text-muted-foreground">
                        –ù—É–∂–Ω–æ: {(e.equip || [])
                          .filter((x) => x !== "none")
                          .map((x) => EQUIPMENT.find((z) => z.id === x)?.label || x)
                          .join(", ") || "‚Äî"}
                      </div>
                    </div>
                    <Badge variant="destructive" className="rounded-xl">–Ω–µ—Ç</Badge>
                  </div>

                  <div className="mt-3 grid gap-2">
                    {suggestions.length ? (
                      suggestions.map((s) => (
                        <div key={s.id} className="rounded-xl border p-2">
                          <div className="flex items-start justify-between gap-3">
                            <div>
                              <div className="text-sm font-medium">‚Üí {s.name}</div>
                              <div className="text-xs text-muted-foreground">{s.muscle}</div>
                            </div>
                            <Badge variant="secondary" className="rounded-xl">–¥–æ—Å—Ç—É–ø–Ω–æ</Badge>
                          </div>
                          <div className="mt-2 text-xs text-muted-foreground">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: {(s.equip || []).map((x) => EQUIPMENT.find((z) => z.id === x)?.label || x).join(", ")}</div>
                        </div>
                      ))
                    ) : (
                      <div className="text-sm text-muted-foreground">–ù–µ –Ω–∞—à—ë–ª –∑–∞–º–µ–Ω—É (–¥–æ–±–∞–≤—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏–ª–∏ —Ä–∞—Å—à–∏—Ä—å –±–∞–∑—É).</div>
                    )}
                  </div>
                </div>
              );
            })}
            {!missingList.length ? <div className="rounded-2xl border bg-muted/30 p-3 text-sm">–ü–æ—Ö–æ–∂–µ, –≤—Å—ë –¥–æ—Å—Ç—É–ø–Ω–æ üòÑ</div> : null}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

function ExerciseRow({
  ex,
  available,
  data,
  setData,
}: {
  ex: Exercise;
  available: Set<string>;
  data: UserState;
  setData: any;
}) {
  const can = hasAllEquipment(ex, available);
  const img = getExerciseImage(data, ex);
  const hasOverride = Boolean(data?.library?.exerciseMedia?.[ex.id]);
  const [show, setShow] = useState(false);

  const setPhotoUrl = () => {
    const url = prompt(
      `–í—Å—Ç–∞–≤—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–π GIF (–ª—É—á—à–µ .gif) –∏–ª–∏ –≤–∏–¥–µ–æ (.mp4/.webm).
–ü–æ–¥–æ–π–¥—É—Ç: https://...  –∏–ª–∏ data:image/... / data:video/...

–û—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º –∏ –Ω–∞–∂–º–∏ OK ‚Äî —á—Ç–æ–±—ã –æ—Ç–º–µ–Ω–∏—Ç—å.`,
      data?.library?.exerciseMedia?.[ex.id] || ""
    );
    if (url === null) return; // cancel
    const trimmed = url.trim();
    if (!trimmed) return;

    setData((d: UserState) => ({
      ...d,
      library: {
        ...(d.library || { exerciseMedia: {} }),
        exerciseMedia: {
          ...(d.library?.exerciseMedia || {}),
          [ex.id]: trimmed,
        },
      },
    }));
  };

  const resetPhoto = () => {
    setData((d: UserState) => {
      const prev = d.library?.exerciseMedia || {};
      if (!prev[ex.id]) return d;
      const next = { ...prev };
      delete next[ex.id];
      return {
        ...d,
        library: {
          ...(d.library || { exerciseMedia: {} }),
          exerciseMedia: next,
        },
      };
    });
  };

  return (
    <div className="rounded-2xl border p-3">
      <div className="flex items-start justify-between gap-3">
        <div className="flex items-start gap-3">
          <button
            className="rounded-xl overflow-hidden border bg-muted/20 shrink-0"
            type="button"
            onClick={() => setShow((s) => !s)}
            title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É"
          >
            <ExerciseMedia src={img} alt={ex.name} mode="thumb" className="h-16 w-24 object-cover" />
          </button>

          <div>
            <div className="text-sm font-medium">{ex.name}</div>
            <div className="text-xs text-muted-foreground">
              –ì–ª–∞–≤–Ω–∞—è: {ex.muscle}
              {ex.secondaryMuscles?.length ? ` ¬∑ –í—Å–ø–æ–º–æ–≥.: ${ex.secondaryMuscles.join(", ")}` : ""}
            </div>
            <div className="mt-2 flex flex-wrap gap-1">{(ex.equip || []).map((e) => <Badge key={e} variant="outline" className="rounded-xl">{EQUIPMENT.find((x) => x.id === e)?.label || e}</Badge>)}</div>
            <div className="mt-2 flex flex-wrap gap-2">
              <Button size="sm" variant="secondary" className="rounded-xl" onClick={setPhotoUrl}>
                {hasOverride ? "–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ" : "–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ"}
              </Button>
              <Button size="sm" variant="secondary" className="rounded-xl" onClick={resetPhoto} disabled={!hasOverride}>
                –°–±—Ä–æ—Å
              </Button>
              <Button size="sm" variant="secondary" className="rounded-xl" onClick={() => setShow(true)}>
                –ü–æ–∫–∞–∑–∞—Ç—å
              </Button>
            </div>
          </div>
        </div>

        <Badge variant={can ? "secondary" : "destructive"} className="rounded-xl">{can ? "–¥–æ—Å—Ç—É–ø–Ω–æ" : "–Ω–µ—Ç"}</Badge>
      </div>

      {show ? (
        <div className="mt-3 rounded-2xl border bg-muted/10 p-2">
          <ExerciseMedia src={img} alt={ex.name} mode="full" className="w-full max-h-[420px] object-contain rounded-xl" />
          <div className="mt-2 text-xs text-muted-foreground">
            –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∏–º–µ–Ω–Ω–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é ‚Äî –Ω–∞–∂–º–∏ ¬´–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ¬ª –∏ –≤—Å—Ç–∞–≤—å URL (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å —Ç–≤–æ–µ–≥–æ –æ–±–ª–∞–∫–∞/–≥–∞–ª–µ—Ä–µ–∏).
          </div>
        </div>
      ) : null}
    </div>
  );
}

// -----------------------------
// Minimal self-tests (console)
// -----------------------------

function runSelfTests() {
  try {
    const b = calcBMR({ sex: "male", weightKg: 70, heightCm: 175, age: 30 } as any);
    console.assert(Math.round(b) === 1649, "calcBMR sanity");

    console.assert(activityFactor("moderate") === 1.55, "activityFactor sanity");

    const m = macroTargets({ weightKg: 80, caloriesTarget: 2200, focus: "fat_loss" });
    console.assert(m.p >= 80 && m.f >= 40 && m.c >= 0, "macroTargets sanity");

    const pr = parsePrescription("3√ó6‚Äì10");
    console.assert(pr.sets === 3 && pr.minReps === 6 && pr.maxReps === 10, "parsePrescription sanity");

    const ws = weekStartMondayISO(new Date(2025, 0, 1));
    console.assert(/^\d{4}-\d{2}-\d{2}$/.test(ws), "weekStart iso format");

    const d2 = addDaysISO("2025-01-01", 3);
    console.assert(d2 === "2025-01-04", "addDaysISO sanity");

    const meal = computeMealFromFoods([
      { foodId: "chicken_breast", grams: 100 },
      { foodId: "rice", grams: 50 },
    ]);
    console.assert(meal.kcal > 0 && meal.p > 0, "computeMealFromFoods sanity");

    const ex0 = resolveExercise("pushup") as any;
    const img0 = placeholderExerciseImage(ex0);
    console.assert(String(img0).startsWith("data:image/svg+xml"), "placeholder image uri");

    const dummyLogs: WorkoutLog[] = [
      {
        id: "x",
        dateISO: "2025-01-06",
        sessionTitle: "A",
        sessionIdx: 0,
        entries: [
          { exerciseId: "pushup", prescription: "3√ó10‚Äì15", sets: [{ reps: 10, weight: null }, { reps: 10, weight: null }, { reps: 10, weight: null }] },
          { exerciseId: "squat_bw", prescription: "3√ó10‚Äì15", sets: [{ reps: 12, weight: null }, { reps: 12, weight: null }, { reps: 12, weight: null }] },
        ],
      },
    ];
    const rep = computeWeeklyMuscleUsage(dummyLogs, "2025-01-06");
    console.assert(rep.data.length >= 2, "weekly muscle usage sanity");
    const chest = rep.data.find((x: any) => x.muscle === "–ì—Ä—É–¥—å");
    const legs = rep.data.find((x: any) => x.muscle === "–ù–æ–≥–∏");
    const core = rep.data.find((x: any) => x.muscle === "–ö–æ—Ä");
    console.assert(chest?.primarySets === 3, "primary sets chest");
    console.assert(legs?.primarySets === 3, "primary sets legs");
    // –ø—Ä–∏—Å–µ–¥ –∏–º–µ–µ—Ç –≤—Ç–æ—Ä–∏—á–Ω—É—é "–ö–æ—Ä" ‚Äî –∑–Ω–∞—á–∏—Ç –∫–æ—Ä –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å secondary
    console.assert((core?.secondarySets || 0) >= 3, "secondary sets core");

    return true;
  } catch (e) {
    console.warn("Self-tests failed", e);
    return false;
  }
}

const g: any = globalThis as any;
if (typeof window !== "undefined" && !g.__VIBE_COACH_TESTS_RAN__) {
  g.__VIBE_COACH_TESTS_RAN__ = true;
  runSelfTests();
}
